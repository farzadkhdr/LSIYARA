<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Rental System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        .navbar-brand {
            font-weight: bold;
        }
        
        .sidebar {
            background-color: var(--secondary-color);
            color: white;
            min-height: calc(100vh - 56px);
            padding: 0;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
            font-weight: 600;
        }
        
        .dashboard-card {
            transition: transform 0.3s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .table-responsive {
            border-radius: 5px;
        }
        
        .tab-content {
            padding: 20px;
            background-color: white;
            border-radius: 0 0 5px 5px;
        }
        
        .nav-tabs .nav-link.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .system-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .copyright {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .print-only {
            display: none;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block;
            }
            body {
                background-color: white;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
        
        .vehicle-details, .customer-details {
            display: none;
            margin-top: 20px;
        }
        
        .suggestion-list {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            display: none;
        }
        
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
        
        .status-returned {
            background-color: #d4edda;
        }
        
        .status-not-returned {
            background-color: #f8d7da;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .invoice-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .invoice-logo img {
            max-width: 200px;
            height: auto;
        }
        
        .custom-logo {
            max-height: 50px;
            margin-right: 10px;
        }
        
        .currency-badge {
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        .user-only {
            display: none;
        }
        
        .system-logo-large {
            max-width: 200px;
            max-height: 80px;
            margin-bottom: 15px;
        }
        
        .signature-area {
            margin-top: 50px;
            border-top: 1px solid #000;
            padding-top: 10px;
        }
        
        .maintenance-status {
            background-color: #fff3cd;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .vehicle-image {
            max-width: 200px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="text-center mb-4">
            <i class="fas fa-car fa-3x text-primary mb-3"></i>
            <h2>Car Rental System</h2>
            <p class="text-muted">Please login to continue</p>
        </div>
        <form id="loginForm">
            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text" class="form-control" id="username" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
        <div class="text-center mt-3">
            <small class="text-muted">Default admin password: 000000</small>
        </div>
        <div class="text-center mt-4">
            <small class="text-muted">Created by Farzad Programmer - Not Editable</small>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <!-- Navigation Bar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark no-print">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <img id="headerLogo" src="" class="custom-logo" style="display: none;">
                    <span id="headerSystemName">Car Rental System</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle"></i> <span id="currentUser">Admin</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal"><i class="fas fa-key"></i> Change Password</a></li>
                                <li class="admin-only"><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#userManagementModal"><i class="fas fa-users"></i> User Management</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-2 sidebar d-none d-md-block no-print">
                    <div class="logo-container">
                        <img id="sidebarLogo" src="" class="system-logo-large" style="display: none;">
                        <span class="system-name" id="sidebarSystemName">RentalSys</span>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item dashboard-item">
                            <a class="nav-link active" href="#dashboard" data-bs-toggle="tab">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item vehicles-item">
                            <a class="nav-link" href="#vehicles" data-bs-toggle="tab">
                                <i class="fas fa-car"></i> Vehicles
                            </a>
                        </li>
                        <li class="nav-item rentals-customers-item">
                            <a class="nav-link" href="#rentals-customers" data-bs-toggle="tab">
                                <i class="fas fa-users"></i> Rentals & Customers
                            </a>
                        </li>
                        <li class="nav-item returns-item">
                            <a class="nav-link" href="#returns" data-bs-toggle="tab">
                                <i class="fas fa-undo"></i> Vehicle Returns
                            </a>
                        </li>
                        <li class="nav-item maintenance-item">
                            <a class="nav-link" href="#maintenance" data-bs-toggle="tab">
                                <i class="fas fa-tools"></i> Vehicle Maintenance
                            </a>
                        </li>
                        <li class="nav-item payments-item">
                            <a class="nav-link" href="#payments" data-bs-toggle="tab">
                                <i class="fas fa-money-bill-wave"></i> Payments
                            </a>
                        </li>
                        <li class="nav-item fines-item">
                            <a class="nav-link" href="#fines" data-bs-toggle="tab">
                                <i class="fas fa-gavel"></i> Fines & Taxes
                            </a>
                        </li>
                        <li class="nav-item reports-item">
                            <a class="nav-link" href="#reports" data-bs-toggle="tab">
                                <i class="fas fa-chart-bar"></i> Reports
                            </a>
                        </li>
                        <li class="nav-item admin-only settings-item">
                            <a class="nav-link" href="#settings" data-bs-toggle="tab">
                                <i class="fas fa-cogs"></i> System Settings
                            </a>
                        </li>
                    </ul>
                    <div class="copyright">
                        Created by Farzad Programmer<br>Not Editable
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-md-10 ms-sm-auto col-lg-10 px-4">
                    <div class="tab-content mt-4">
                        <!-- Dashboard Tab -->
                        <div class="tab-pane fade show active" id="dashboard">
                            <h2 class="mb-4">Dashboard</h2>
                            <div class="row" id="dashboardStats">
                                <!-- Dashboard statistics will be loaded here -->
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            Recent Rentals
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Customer</th>
                                                            <th>Vehicle</th>
                                                            <th>Date</th>
                                                            <th>Amount</th>
                                                            <th>Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="recentRentalsTable">
                                                        <!-- Recent rentals will be loaded here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            Vehicle Status
                                        </div>
                                        <div class="card-body">
                                            <canvas id="vehicleStatusChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vehicles Tab -->
                        <div class="tab-pane fade" id="vehicles">
                            <h2 class="mb-4">Vehicle Management</h2>
                            
                            <ul class="nav nav-tabs mb-3">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#addVehicle">Add Vehicle</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#vehicleList">Vehicle List</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#vehicleHistory">Vehicle History</a>
                                </li>
                            </ul>
                            
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="addVehicle">
                                    <div class="card">
                                        <div class="card-header">
                                            Add New Vehicle
                                        </div>
                                        <div class="card-body">
                                            <form id="addVehicleForm">
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleName" class="form-label">Vehicle Name</label>
                                                        <input type="text" class="form-control" id="vehicleName" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleOdometer" class="form-label">Odometer</label>
                                                        <input type="number" class="form-control" id="vehicleOdometer" required>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleVin" class="form-label">VIN #</label>
                                                        <input type="text" class="form-control" id="vehicleVin" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehiclePlate" class="form-label">Plate Number</label>
                                                        <input type="text" class="form-control" id="vehiclePlate" required>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleColor" class="form-label">Color</label>
                                                        <input type="text" class="form-control" id="vehicleColor" placeholder="Type color..." required>
                                                        <div class="suggestion-list" id="colorSuggestions"></div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleModel" class="form-label">Model</label>
                                                        <input type="text" class="form-control" id="vehicleModel" placeholder="Type model year..." required>
                                                        <div class="suggestion-list" id="modelSuggestions"></div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleRentalPrice" class="form-label">Rental Price (per day)</label>
                                                        <div class="input-group">
                                                            <input type="number" class="form-control" id="vehicleRentalPrice" required>
                                                            <span class="input-group-text">AED</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleImage" class="form-label">Vehicle Image</label>
                                                        <input type="file" class="form-control" id="vehicleImage" accept="image/*">
                                                    </div>
                                                </div>
                                                <button type="submit" class="btn btn-primary">Add Vehicle</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="vehicleList">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Vehicle List</span>
                                            <div class="input-group" style="width: 300px;">
                                                <input type="text" class="form-control" id="vehicleSearch" placeholder="Search vehicles...">
                                                <button class="btn btn-outline-secondary" type="button" id="vehicleSearchBtn">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Image</th>
                                                            <th>Name</th>
                                                            <th>Model</th>
                                                            <th>Color</th>
                                                            <th>Plate #</th>
                                                            <th>Odometer</th>
                                                            <th>Rental Price</th>
                                                            <th>Status</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="vehicleTableBody">
                                                        <!-- Vehicle data will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Vehicle Details Section -->
                                    <div class="card vehicle-details" id="vehicleDetailsCard">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Vehicle Details</span>
                                            <button class="btn btn-sm btn-secondary" id="closeVehicleDetails">Close</button>
                                        </div>
                                        <div class="card-body" id="vehicleDetailsContent">
                                            <!-- Vehicle details will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="vehicleHistory">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Vehicle Rental History</span>
                                            <div class="input-group" style="width: 300px;">
                                                <input type="text" class="form-control" id="vehicleHistorySearch" placeholder="Search by vehicle name...">
                                                <button class="btn btn-outline-secondary" type="button" id="vehicleHistorySearchBtn">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Vehicle</th>
                                                            <th>Customer</th>
                                                            <th>Rental Date</th>
                                                            <th>Return Date</th>
                                                            <th>Amount</th>
                                                            <th>Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="vehicleHistoryTableBody">
                                                        <!-- Vehicle history will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rentals & Customers Tab -->
                        <div class="tab-pane fade" id="rentals-customers">
                            <h2 class="mb-4">Rentals & Customers Management</h2>
                            
                            <ul class="nav nav-tabs mb-3">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#addCustomer">Add Customer</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#customerList">Customer List</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#createRental">Create Rental</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#rentalList">Rental List</a>
                                </li>
                            </ul>
                            
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="addCustomer">
                                    <div class="card">
                                        <div class="card-header">
                                            Add New Customer
                                        </div>
                                        <div class="card-body">
                                            <form id="addCustomerForm">
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="customerFullName" class="form-label">Full Name</label>
                                                        <input type="text" class="form-control" id="customerFullName" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="customerAge" class="form-label">Age</label>
                                                        <input type="number" class="form-control" id="customerAge" required>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="customerId" class="form-label">PS/ID</label>
                                                        <input type="text" class="form-control" id="customerId" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="customerNationality" class="form-label">Nationality</label>
                                                        <input type="text" class="form-control" id="customerNationality" placeholder="Type country name..." required>
                                                        <div class="suggestion-list" id="nationalitySuggestions"></div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="customerContact" class="form-label">Contact Number</label>
                                                        <input type="text" class="form-control" id="customerContact" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="customerAddress" class="form-label">Address</label>
                                                        <input type="text" class="form-control" id="customerAddress" required>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="guaranteeDoc" class="form-label">Guarantee / Document</label>
                                                    <input type="file" class="form-control" id="guaranteeDoc">
                                                </div>
                                                <button type="submit" class="btn btn-primary">Add Customer</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="customerList">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Customer List</span>
                                            <div class="input-group" style="width: 300px;">
                                                <input type="text" class="form-control" id="customerSearch" placeholder="Search customers...">
                                                <button class="btn btn-outline-secondary" type="button" id="customerSearchBtn">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Full Name</th>
                                                            <th>Age</th>
                                                            <th>ID</th>
                                                            <th>Nationality</th>
                                                            <th>Contact</th>
                                                            <th>Total Debt</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="customerTableBody">
                                                        <!-- Customer data will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Customer Details Section -->
                                    <div class="card customer-details" id="customerDetailsCard">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Customer Details</span>
                                            <button class="btn btn-sm btn-secondary" id="closeCustomerDetails">Close</button>
                                        </div>
                                        <div class="card-body" id="customerDetailsContent">
                                            <!-- Customer details will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="createRental">
                                    <div class="card">
                                        <div class="card-header">
                                            Create New Rental
                                        </div>
                                        <div class="card-body">
                                            <form id="createRentalForm">
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="rentalCustomer" class="form-label">Customer</label>
                                                        <input type="text" class="form-control" id="rentalCustomer" placeholder="Search customer...">
                                                        <div class="suggestion-list" id="customerSuggestions"></div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="rentalVehicle" class="form-label">Vehicle</label>
                                                        <input type="text" class="form-control" id="rentalVehicle" placeholder="Search vehicle...">
                                                        <div class="suggestion-list" id="vehicleSuggestions"></div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="rentalAmount" class="form-label">Rental Amount (per day)</label>
                                                        <div class="input-group">
                                                            <input type="number" class="form-control" id="rentalAmount" required>
                                                            <span class="input-group-text">AED</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="rentalDays" class="form-label">Rental Days</label>
                                                        <input type="number" class="form-control" id="rentalDays" required>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="rentalStartDate" class="form-label">Rental Start Date</label>
                                                        <input type="date" class="form-control" id="rentalStartDate" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="rentalEndDate" class="form-label">Rental End Date</label>
                                                        <input type="date" class="form-control" id="rentalEndDate" required>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="invoiceCode" class="form-label">Invoice Code</label>
                                                        <input type="text" class="form-control" id="invoiceCode">
                                                    </div>
                                                </div>
                                                <button type="submit" class="btn btn-primary">Create Rental</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="rentalList">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Rental History</span>
                                            <div class="input-group" style="width: 300px;">
                                                <input type="text" class="form-control" id="rentalSearch" placeholder="Search by invoice code...">
                                                <button class="btn btn-outline-secondary" type="button" id="rentalSearchBtn">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Invoice Code</th>
                                                            <th>Customer</th>
                                                            <th>Vehicle</th>
                                                            <th>Start Date</th>
                                                            <th>End Date</th>
                                                            <th>Amount</th>
                                                            <th>Status</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="rentalTableBody">
                                                        <!-- Rental data will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Invoice for Printing -->
                            <div id="invoicePrint" class="print-only" style="display: none;">
                                <div class="invoice-logo">
                                    <img id="printLogo" src="" style="max-width: 200px; display: none;">
                                    <h3 id="printSystemName">Car Rental System</h3>
                                </div>
                                <div class="card">
                                    <div class="card-header text-center">
                                        <h3>Car Rental Invoice</h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <strong>Invoice Code:</strong> <span id="printInvoiceCode"></span>
                                            </div>
                                            <div class="col-6 text-end">
                                                <strong>Date:</strong> <span id="printInvoiceDate"></span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <strong>Customer:</strong> <span id="printCustomerName"></span>
                                            </div>
                                            <div class="col-6">
                                                <strong>Vehicle:</strong> <span id="printVehicleName"></span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <strong>Customer ID:</strong> <span id="printCustomerId"></span>
                                            </div>
                                            <div class="col-6">
                                                <strong>Customer Address:</strong> <span id="printCustomerAddress"></span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-12">
                                                <strong>Rental Amount (per day):</strong> <span id="printRentalAmount"></span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-12">
                                                <strong>Rental Days:</strong> <span id="printRentalDays"></span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-12">
                                                <strong>Rental History:</strong>
                                                <div id="printRentalHistory"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <hr>
                                                <h4 class="text-end">Total: <span id="printTotalAmount"></span></h4>
                                            </div>
                                        </div>
                                        <div class="row signature-area">
                                            <div class="col-6">
                                                <strong>Customer Signature:</strong>
                                                <div style="height: 50px; border-bottom: 1px solid #000;"></div>
                                            </div>
                                            <div class="col-6 text-end">
                                                <strong>Company Signature:</strong>
                                                <div style="height: 50px; border-bottom: 1px solid #000;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vehicle Returns Tab -->
                        <div class="tab-pane fade" id="returns">
                            <h2 class="mb-4">Vehicle Returns</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Return Vehicle
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="returnInvoiceSearch" class="form-label">Search by Invoice Code</label>
                                            <input type="text" class="form-control" id="returnInvoiceSearch" placeholder="Search invoice code...">
                                            <div class="suggestion-list" id="returnInvoiceSuggestions"></div>
                                        </div>
                                        <div class="col-md-6 d-flex align-items-end">
                                            <button class="btn btn-primary me-2" id="searchInvoiceBtn">Search</button>
                                        </div>
                                    </div>
                                    <div id="returnFormContainer" style="display: none;">
                                        <form id="returnVehicleForm">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Customer</label>
                                                    <input type="text" class="form-control" id="returnCustomer" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Vehicle</label>
                                                    <input type="text" class="form-control" id="returnVehicle" readonly>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Rental Start Date</label>
                                                    <input type="text" class="form-control" id="returnStartDate" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Rental End Date</label>
                                                    <input type="text" class="form-control" id="returnEndDate" readonly>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="returnOdometer" class="form-label">Odometer on Return</label>
                                                    <input type="number" class="form-control" id="returnOdometer" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="returnDate" class="form-label">Return Date</label>
                                                    <input type="date" class="form-control" id="returnDate" required>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="returnTime" class="form-label">Return Time</label>
                                                    <input type="time" class="form-control" id="returnTime" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="returnFuelLevel" class="form-label">Fuel Level</label>
                                                    <select class="form-select" id="returnFuelLevel" required>
                                                        <option value="">Select fuel level</option>
                                                        <option value="Full">Full</option>
                                                        <option value="3/4">3/4</option>
                                                        <option value="1/2">1/2</option>
                                                        <option value="1/4">1/4</option>
                                                        <option value="Empty">Empty</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <label for="returnNotes" class="form-label">Notes</label>
                                                    <textarea class="form-control" id="returnNotes" rows="3"></textarea>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <label for="returnImages" class="form-label">Vehicle Images on Return</label>
                                                    <input type="file" class="form-control" id="returnImages" accept="image/*" multiple>
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-success">Complete Return</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Return History</span>
                                    <div class="input-group" style="width: 300px;">
                                        <input type="text" class="form-control" id="returnHistorySearch" placeholder="Search by invoice code...">
                                        <button class="btn btn-outline-secondary" type="button" id="returnHistorySearchBtn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Invoice Code</th>
                                                    <th>Customer</th>
                                                    <th>Vehicle</th>
                                                    <th>Return Date</th>
                                                    <th>Odometer</th>
                                                    <th>Fuel Level</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="returnHistoryTableBody">
                                                <!-- Return history will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vehicle Maintenance Tab -->
                        <div class="tab-pane fade" id="maintenance">
                            <h2 class="mb-4">Vehicle Maintenance</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Schedule Maintenance
                                </div>
                                <div class="card-body">
                                    <form id="scheduleMaintenanceForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="maintenanceVehicle" class="form-label">Vehicle</label>
                                                <input type="text" class="form-control" id="maintenanceVehicle" placeholder="Search vehicle...">
                                                <div class="suggestion-list" id="maintenanceVehicleSuggestions"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="maintenanceType" class="form-label">Maintenance Type</label>
                                                <select class="form-select" id="maintenanceType" required>
                                                    <option value="">Select type</option>
                                                    <option value="Oil Change">Oil Change</option>
                                                    <option value="Tire Rotation">Tire Rotation</option>
                                                    <option value="Brake Service">Brake Service</option>
                                                    <option value="Engine Tune-up">Engine Tune-up</option>
                                                    <option value="Other">Other</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="maintenanceDate" class="form-label">Maintenance Date</label>
                                                <input type="date" class="form-control" id="maintenanceDate" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="maintenanceCost" class="form-label">Cost</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="maintenanceCost" required>
                                                    <span class="input-group-text">AED</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <label for="maintenanceDescription" class="form-label">Description</label>
                                                <textarea class="form-control" id="maintenanceDescription" rows="3"></textarea>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Schedule Maintenance</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Maintenance History</span>
                                    <div class="input-group" style="width: 300px;">
                                        <input type="text" class="form-control" id="maintenanceSearch" placeholder="Search by vehicle...">
                                        <button class="btn btn-outline-secondary" type="button" id="maintenanceSearchBtn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Vehicle</th>
                                                    <th>Maintenance Type</th>
                                                    <th>Date</th>
                                                    <th>Cost</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="maintenanceTableBody">
                                                <!-- Maintenance data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payments Tab -->
                        <div class="tab-pane fade" id="payments">
                            <h2 class="mb-4">Payment Management</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Payment Processing
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="paymentCustomerSearch" class="form-label">Search Customer</label>
                                            <input type="text" class="form-control" id="paymentCustomerSearch" placeholder="Search customer name...">
                                            <div class="suggestion-list" id="paymentCustomerSuggestions"></div>
                                        </div>
                                        <div class="col-md-6 d-flex align-items-end">
                                            <button class="btn btn-primary me-2" id="searchPaymentCustomerBtn">Search</button>
                                        </div>
                                    </div>
                                    <div id="paymentDetailsContainer" style="display: none;">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <h5>Customer Information</h5>
                                                <p><strong>Name:</strong> <span id="paymentCustomerName"></span></p>
                                                <p><strong>ID:</strong> <span id="paymentCustomerId"></span></p>
                                                <p><strong>Contact:</strong> <span id="paymentCustomerContact"></span></p>
                                            </div>
                                            <div class="col-md-6">
                                                <h5>Debt Summary</h5>
                                                <p><strong>Rental Debt:</strong> <span id="paymentRentalDebt">0</span> AED</p>
                                                <p><strong>Fines Debt:</strong> <span id="paymentFinesDebt">0</span> AED</p>
                                                <p><strong>Total Debt:</strong> <span id="paymentTotalDebt">0</span> AED</p>
                                            </div>
                                        </div>
                                        <form id="processPaymentForm">
                                            <input type="hidden" id="paymentCustomerIdInput">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="paymentAmount" class="form-label">Payment Amount</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="paymentAmount" required>
                                                        <span class="input-group-text">AED</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="paymentDate" class="form-label">Payment Date</label>
                                                    <input type="date" class="form-control" id="paymentDate" required>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="paymentTime" class="form-label">Payment Time</label>
                                                    <input type="time" class="form-control" id="paymentTime" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="paymentMethod" class="form-label">Payment Method</label>
                                                    <select class="form-select" id="paymentMethod" required>
                                                        <option value="">Select method</option>
                                                        <option value="Cash">Cash</option>
                                                        <option value="Credit Card">Credit Card</option>
                                                        <option value="Bank Transfer">Bank Transfer</option>
                                                        <option value="Other">Other</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <label for="paymentNotes" class="form-label">Notes</label>
                                                    <textarea class="form-control" id="paymentNotes" rows="3"></textarea>
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-success">Process Payment</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Payment History</span>
                                    <div class="input-group" style="width: 300px;">
                                        <input type="text" class="form-control" id="paymentHistorySearch" placeholder="Search by customer name...">
                                        <button class="btn btn-outline-secondary" type="button" id="paymentHistorySearchBtn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Customer</th>
                                                    <th>Payment Date</th>
                                                    <th>Payment Time</th>
                                                    <th>Amount</th>
                                                    <th>Method</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="paymentHistoryTableBody">
                                                <!-- Payment history will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fines & Taxes Tab -->
                        <div class="tab-pane fade" id="fines">
                            <h2 class="mb-4">Fines & Taxes Management</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Add Fine/Tax
                                </div>
                                <div class="card-body">
                                    <form id="addFineForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="fineCustomer" class="form-label">Customer</label>
                                                <input type="text" class="form-control" id="fineCustomer" placeholder="Search customer...">
                                                <div class="suggestion-list" id="fineCustomerSuggestions"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="fineType" class="form-label">Fine Type</label>
                                                <select class="form-select" id="fineType" required>
                                                    <option value="">Select type</option>
                                                    <option value="Traffic Violation">Traffic Violation</option>
                                                    <option value="Late Return">Late Return</option>
                                                    <option value="Vehicle Damage">Vehicle Damage</option>
                                                    <option value="Cleaning Fee">Cleaning Fee</option>
                                                    <option value="Tax">Tax</option>
                                                    <option value="Other">Other</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="fineAmount" class="form-label">Amount</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="fineAmount" required>
                                                    <span class="input-group-text">AED</span>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="fineDate" class="form-label">Fine Date</label>
                                                <input type="date" class="form-control" id="fineDate" required>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <label for="fineDescription" class="form-label">Description</label>
                                                <textarea class="form-control" id="fineDescription" rows="3"></textarea>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Add Fine/Tax</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Fines & Taxes History</span>
                                    <div class="input-group" style="width: 300px;">
                                        <input type="text" class="form-control" id="finesSearch" placeholder="Search by customer...">
                                        <button class="btn btn-outline-secondary" type="button" id="finesSearchBtn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Customer</th>
                                                    <th>Fine Type</th>
                                                    <th>Date</th>
                                                    <th>Amount</th>
                                                    <th>Description</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="finesTableBody">
                                                <!-- Fines data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reports Tab -->
                        <div class="tab-pane fade" id="reports">
                            <h2 class="mb-4">Reports</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Generate Report
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label for="reportType" class="form-label">Report Type</label>
                                            <select class="form-select" id="reportType">
                                                <option value="rental">Rental Report</option>
                                                <option value="financial">Financial Report</option>
                                                <option value="vehicle">Vehicle Report</option>
                                                <option value="customer">Customer Report</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="reportStartDate" class="form-label">Start Date</label>
                                            <input type="date" class="form-control" id="reportStartDate">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="reportEndDate" class="form-label">End Date</label>
                                            <input type="date" class="form-control" id="reportEndDate">
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" id="generateReportBtn">Generate Report</button>
                                    <button class="btn btn-success ms-2" id="exportReportBtn">Export to Excel</button>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    Report Results
                                </div>
                                <div class="card-body">
                                    <div id="reportResults">
                                        <!-- Report results will be displayed here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Settings Tab -->
                        <div class="tab-pane fade" id="settings">
                            <h2 class="mb-4">System Settings</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    System Configuration
                                </div>
                                <div class="card-body">
                                    <form id="systemSettingsForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="systemName" class="form-label">System Name</label>
                                                <input type="text" class="form-control" id="systemName">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="systemLogo" class="form-label">System Logo</label>
                                                <input type="file" class="form-control" id="systemLogo" accept="image/*">
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="systemCurrency" class="form-label">Currency</label>
                                                <input type="text" class="form-control" id="systemCurrency" value="AED" readonly>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="systemDateFormat" class="form-label">Date Format</label>
                                                <select class="form-select" id="systemDateFormat">
                                                    <option value="dd/mm/yyyy">DD/MM/YYYY</option>
                                                    <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                                                    <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="backupInterval" class="form-label">Backup Interval</label>
                                                <select class="form-select" id="backupInterval">
                                                    <option value="daily">Daily</option>
                                                    <option value="weekly">Weekly</option>
                                                    <option value="monthly">Monthly</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 d-flex align-items-end">
                                                <button type="button" class="btn btn-warning me-2" id="createBackupBtn">Create Backup Now</button>
                                                <button type="button" class="btn btn-info" id="restoreBackupBtn">Restore Backup</button>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label for="adminPassword" class="form-label">Admin Password</label>
                                                <input type="password" class="form-control" id="adminPassword" placeholder="Enter new admin password">
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Save Settings</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    User Management
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Username</th>
                                                    <th>Role</th>
                                                    <th>Permissions</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="userManagementTable">
                                                <!-- User management data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addUserModal">Add User</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Change Password</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label for="newUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="newUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="newUserPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="newUserPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newUserRole" class="form-label">Role</label>
                            <select class="form-select" id="newUserRole" required>
                                <option value="admin">Admin</option>
                                <option value="viewer">Viewer</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Permissions</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="permissionVehicles" checked>
                                <label class="form-check-label" for="permissionVehicles">Vehicles Management</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="permissionRentals" checked>
                                <label class="form-check-label" for="permissionRentals">Rentals Management</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="permissionPayments" checked>
                                <label class="form-check-label" for="permissionPayments">Payments Management</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="permissionReports" checked>
                                <label class="form-check-label" for="permissionReports">Reports</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add User</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal fade" id="userManagementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Permissions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userManagementModalTable">
                                <!-- User management data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addUserModal">Add User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Data storage
        let vehicles = JSON.parse(localStorage.getItem('vehicles')) || [];
        let customers = JSON.parse(localStorage.getItem('customers')) || [];
        let rentals = JSON.parse(localStorage.getItem('rentals')) || [];
        let returns = JSON.parse(localStorage.getItem('returns')) || [];
        let maintenance = JSON.parse(localStorage.getItem('maintenance')) || [];
        let payments = JSON.parse(localStorage.getItem('payments')) || [];
        let fines = JSON.parse(localStorage.getItem('fines')) || [];
        let users = JSON.parse(localStorage.getItem('users')) || [{ username: 'admin', password: '000000', role: 'admin' }];
        let settings = JSON.parse(localStorage.getItem('settings')) || { systemName: 'Car Rental System', currency: 'AED', dateFormat: 'dd/mm/yyyy' };
        let currentUser = null;

        // Color suggestions
        const colorSuggestions = ['Red', 'Blue', 'Green', 'Black', 'White', 'Silver', 'Gray', 'Yellow', 'Orange', 'Purple', 'Brown', 'Pink', 'Gold', 'Beige', 'Maroon', 'Navy', 'Teal', 'Olive', 'Lime', 'Aqua', 'Cyan', 'Magenta', 'Coral', 'Indigo', 'Violet', 'Turquoise', 'Tan', 'Charcoal', 'Bronze', 'Cream'];
        
        // Model year suggestions
        const modelSuggestions = ['2019', '2020', '2021', '2022', '2023', '2024', '2025', '2026', '2027', '2028', '2029', '2030'];
        
        // Country suggestions for nationality
        const countrySuggestions = [
            'Afghanistan', 'Albania', 'Algeria', 'Andorra', 'Angola', 'Antigua and Barbuda', 'Argentina', 'Armenia', 'Australia', 'Austria',
            'Azerbaijan', 'Bahamas', 'Bahrain', 'Bangladesh', 'Barbados', 'Belarus', 'Belgium', 'Belize', 'Benin', 'Bhutan',
            'Bolivia', 'Bosnia and Herzegovina', 'Botswana', 'Brazil', 'Brunei', 'Bulgaria', 'Burkina Faso', 'Burundi', 'Cabo Verde', 'Cambodia',
            'Cameroon', 'Canada', 'Central African Republic', 'Chad', 'Chile', 'China', 'Colombia', 'Comoros', 'Congo', 'Costa Rica',
            'Croatia', 'Cuba', 'Cyprus', 'Czech Republic', 'Denmark', 'Djibouti', 'Dominica', 'Dominican Republic', 'East Timor', 'Ecuador',
            'Egypt', 'El Salvador', 'Equatorial Guinea', 'Eritrea', 'Estonia', 'Eswatini', 'Ethiopia', 'Fiji', 'Finland', 'France',
            'Gabon', 'Gambia', 'Georgia', 'Germany', 'Ghana', 'Greece', 'Grenada', 'Guatemala', 'Guinea', 'Guinea-Bissau',
            'Guyana', 'Haiti', 'Honduras', 'Hungary', 'Iceland', 'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland',
            'Israel', 'Italy', 'Jamaica', 'Japan', 'Jordan', 'Kazakhstan', 'Kenya', 'Kiribati', 'Korea, North', 'Korea, South',
            'Kosovo', 'Kuwait', 'Kyrgyzstan', 'Laos', 'Latvia', 'Lebanon', 'Lesotho', 'Liberia', 'Libya', 'Liechtenstein',
            'Lithuania', 'Luxembourg', 'Madagascar', 'Malawi', 'Malaysia', 'Maldives', 'Mali', 'Malta', 'Marshall Islands', 'Mauritania',
            'Mauritius', 'Mexico', 'Micronesia', 'Moldova', 'Monaco', 'Mongolia', 'Montenegro', 'Morocco', 'Mozambique', 'Myanmar',
            'Namibia', 'Nauru', 'Nepal', 'Netherlands', 'New Zealand', 'Nicaragua', 'Niger', 'Nigeria', 'North Macedonia', 'Norway',
            'Oman', 'Pakistan', 'Palau', 'Palestine', 'Panama', 'Papua New Guinea', 'Paraguay', 'Peru', 'Philippines', 'Poland',
            'Portugal', 'Qatar', 'Romania', 'Russia', 'Rwanda', 'Saint Kitts and Nevis', 'Saint Lucia', 'Saint Vincent and the Grenadines', 'Samoa', 'San Marino',
            'Sao Tome and Principe', 'Saudi Arabia', 'Senegal', 'Serbia', 'Seychelles', 'Sierra Leone', 'Singapore', 'Slovakia', 'Slovenia', 'Solomon Islands',
            'Somalia', 'South Africa', 'South Sudan', 'Spain', 'Sri Lanka', 'Sudan', 'Suriname', 'Sweden', 'Switzerland', 'Syria',
            'Taiwan', 'Tajikistan', 'Tanzania', 'Thailand', 'Togo', 'Tonga', 'Trinidad and Tobago', 'Tunisia', 'Turkey', 'Turkmenistan',
            'Tuvalu', 'Uganda', 'Ukraine', 'United Arab Emirates', 'United Kingdom', 'United States', 'Uruguay', 'Uzbekistan', 'Vanuatu', 'Vatican City',
            'Venezuela', 'Vietnam', 'Yemen', 'Zambia', 'Zimbabwe'
        ];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            const loggedInUser = localStorage.getItem('currentUser');
            if (loggedInUser) {
                currentUser = JSON.parse(loggedInUser);
                showMainApp();
            } else {
                showLoginScreen();
            }
            
            // Initialize event listeners
            initEventListeners();
            
            // Load initial data
            loadDashboardData();
            loadVehicleData();
            loadCustomerData();
            loadRentalData();
            loadReturnData();
            loadMaintenanceData();
            loadPaymentData();
            loadFinesData();
            loadUserManagementData();
            loadSettings();
        });

        // Show login screen
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        }

        // Show main application
        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Update UI based on user role
            updateUIForUserRole();
        }

        // Update UI based on user role
        function updateUIForUserRole() {
            if (currentUser && currentUser.role === 'admin') {
                // Show all admin elements
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'block';
                });
                document.querySelectorAll('.user-only').forEach(el => {
                    el.style.display = 'none';
                });
            } else {
                // Hide admin elements for non-admin users
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'none';
                });
                document.querySelectorAll('.user-only').forEach(el => {
                    el.style.display = 'block';
                });
            }
            
            // Update current user display
            if (currentUser) {
                document.getElementById('currentUser').textContent = currentUser.username;
            }
        }

        // Initialize event listeners
        function initEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Change password form
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
            
            // Add user form
            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
            
            // System settings form
            document.getElementById('systemSettingsForm').addEventListener('submit', handleSaveSettings);
            
            // Create backup button
            document.getElementById('createBackupBtn').addEventListener('click', handleCreateBackup);
            
            // Restore backup button
            document.getElementById('restoreBackupBtn').addEventListener('click', handleRestoreBackup);
            
            // Add vehicle form
            document.getElementById('addVehicleForm').addEventListener('submit', handleAddVehicle);
            
            // Vehicle search
            document.getElementById('vehicleSearchBtn').addEventListener('click', handleVehicleSearch);
            document.getElementById('vehicleSearch').addEventListener('input', handleVehicleSearch);
            
            // Vehicle history search
            document.getElementById('vehicleHistorySearchBtn').addEventListener('click', handleVehicleHistorySearch);
            document.getElementById('vehicleHistorySearch').addEventListener('input', handleVehicleHistorySearch);
            
            // Add customer form
            document.getElementById('addCustomerForm').addEventListener('submit', handleAddCustomer);
            
            // Customer search
            document.getElementById('customerSearchBtn').addEventListener('click', handleCustomerSearch);
            document.getElementById('customerSearch').addEventListener('input', handleCustomerSearch);
            
            // Create rental form
            document.getElementById('createRentalForm').addEventListener('submit', handleCreateRental);
            
            // Rental search
            document.getElementById('rentalSearchBtn').addEventListener('click', handleRentalSearch);
            document.getElementById('rentalSearch').addEventListener('input', handleRentalSearch);
            
            // Return vehicle form
            document.getElementById('returnVehicleForm').addEventListener('submit', handleReturnVehicle);
            
            // Search invoice for return
            document.getElementById('searchInvoiceBtn').addEventListener('click', handleSearchInvoice);
            document.getElementById('returnInvoiceSearch').addEventListener('input', handleReturnInvoiceSearch);
            
            // Return history search
            document.getElementById('returnHistorySearchBtn').addEventListener('click', handleReturnHistorySearch);
            document.getElementById('returnHistorySearch').addEventListener('input', handleReturnHistorySearch);
            
            // Schedule maintenance form
            document.getElementById('scheduleMaintenanceForm').addEventListener('submit', handleScheduleMaintenance);
            
            // Maintenance search
            document.getElementById('maintenanceSearchBtn').addEventListener('click', handleMaintenanceSearch);
            document.getElementById('maintenanceSearch').addEventListener('input', handleMaintenanceSearch);
            
            // Process payment form
            document.getElementById('processPaymentForm').addEventListener('submit', handleProcessPayment);
            
            // Search payment customer
            document.getElementById('searchPaymentCustomerBtn').addEventListener('click', handleSearchPaymentCustomer);
            document.getElementById('paymentCustomerSearch').addEventListener('input', handlePaymentCustomerSearch);
            
            // Payment history search
            document.getElementById('paymentHistorySearchBtn').addEventListener('click', handlePaymentHistorySearch);
            document.getElementById('paymentHistorySearch').addEventListener('input', handlePaymentHistorySearch);
            
            // Add fine form
            document.getElementById('addFineForm').addEventListener('submit', handleAddFine);
            
            // Fines search
            document.getElementById('finesSearchBtn').addEventListener('click', handleFinesSearch);
            document.getElementById('finesSearch').addEventListener('input', handleFinesSearch);
            
            // Generate report
            document.getElementById('generateReportBtn').addEventListener('click', handleGenerateReport);
            
            // Export report
            document.getElementById('exportReportBtn').addEventListener('click', handleExportReport);
            
            // Close vehicle details
            document.getElementById('closeVehicleDetails').addEventListener('click', function() {
                document.getElementById('vehicleDetailsCard').style.display = 'none';
            });
            
            // Close customer details
            document.getElementById('closeCustomerDetails').addEventListener('click', function() {
                document.getElementById('customerDetailsCard').style.display = 'none';
            });
            
            // Color suggestions
            document.getElementById('vehicleColor').addEventListener('input', function() {
                showSuggestions(this, colorSuggestions, 'colorSuggestions');
            });
            
            // Model suggestions
            document.getElementById('vehicleModel').addEventListener('input', function() {
                showSuggestions(this, modelSuggestions, 'modelSuggestions');
            });
            
            // Nationality suggestions
            document.getElementById('customerNationality').addEventListener('input', function() {
                showSuggestions(this, countrySuggestions, 'nationalitySuggestions');
            });
            
            // Customer suggestions for rental
            document.getElementById('rentalCustomer').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredCustomers = customers.filter(customer => 
                    customer.fullName.toLowerCase().includes(searchTerm)
                );
                showSuggestions(this, filteredCustomers.map(c => c.fullName), 'customerSuggestions');
            });
            
            // Vehicle suggestions for rental
            document.getElementById('rentalVehicle').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredVehicles = vehicles.filter(vehicle => 
                    vehicle.name.toLowerCase().includes(searchTerm) && vehicle.status === 'Available'
                );
                showSuggestions(this, filteredVehicles.map(v => v.name), 'vehicleSuggestions');
            });
            
            // Invoice suggestions for return
            document.getElementById('returnInvoiceSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredRentals = rentals.filter(rental => 
                    rental.invoiceCode.toLowerCase().includes(searchTerm) && rental.status === 'Active'
                );
                showSuggestions(this, filteredRentals.map(r => r.invoiceCode), 'returnInvoiceSuggestions');
            });
            
            // Vehicle suggestions for maintenance
            document.getElementById('maintenanceVehicle').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredVehicles = vehicles.filter(vehicle => 
                    vehicle.name.toLowerCase().includes(searchTerm)
                );
                showSuggestions(this, filteredVehicles.map(v => v.name), 'maintenanceVehicleSuggestions');
            });
            
            // Customer suggestions for payment
            document.getElementById('paymentCustomerSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredCustomers = customers.filter(customer => 
                    customer.fullName.toLowerCase().includes(searchTerm)
                );
                showSuggestions(this, filteredCustomers.map(c => c.fullName), 'paymentCustomerSuggestions');
            });
            
            // Customer suggestions for fines
            document.getElementById('fineCustomer').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredCustomers = customers.filter(customer => 
                    customer.fullName.toLowerCase().includes(searchTerm)
                );
                showSuggestions(this, filteredCustomers.map(c => c.fullName), 'fineCustomerSuggestions');
            });
        }

        // Show suggestions for input fields
        function showSuggestions(inputElement, suggestions, containerId) {
            const searchTerm = inputElement.value.toLowerCase();
            const container = document.getElementById(containerId);
            
            if (searchTerm.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            const filteredSuggestions = suggestions.filter(suggestion => 
                suggestion.toString().toLowerCase().includes(searchTerm)
            );
            
            if (filteredSuggestions.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.innerHTML = '';
            filteredSuggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = suggestion;
                div.addEventListener('click', function() {
                    inputElement.value = suggestion;
                    container.style.display = 'none';
                });
                container.appendChild(div);
            });
            
            container.style.display = 'block';
            container.style.width = inputElement.offsetWidth + 'px';
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainApp();
            } else {
                alert('Invalid username or password');
            }
        }

        // Handle logout
        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showLoginScreen();
        }

        // Handle change password
        function handleChangePassword(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (currentUser.password !== currentPassword) {
                alert('Current password is incorrect');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }
            
            currentUser.password = newPassword;
            const userIndex = users.findIndex(u => u.username === currentUser.username);
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                alert('Password changed successfully');
                document.getElementById('changePasswordModal').querySelector('.btn-close').click();
            }
        }

        // Handle add user
        function handleAddUser(e) {
            e.preventDefault();
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            // Check if username already exists
            if (users.find(u => u.username === username)) {
                alert('Username already exists');
                return;
            }
            
            const newUser = {
                username,
                password,
                role
            };
            
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            alert('User added successfully');
            document.getElementById('addUserModal').querySelector('.btn-close').click();
            loadUserManagementData();
        }

        // Handle save settings
        function handleSaveSettings(e) {
            e.preventDefault();
            const systemName = document.getElementById('systemName').value;
            const dateFormat = document.getElementById('systemDateFormat').value;
            const backupInterval = document.getElementById('backupInterval').value;
            const adminPassword = document.getElementById('adminPassword').value;
            
            settings.systemName = systemName;
            settings.dateFormat = dateFormat;
            settings.backupInterval = backupInterval;
            
            // Handle system logo
            const logoFile = document.getElementById('systemLogo').files[0];
            if (logoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    settings.logo = e.target.result;
                    localStorage.setItem('settings', JSON.stringify(settings));
                    loadSettings();
                    alert('Settings saved successfully');
                };
                reader.readAsDataURL(logoFile);
            } else {
                localStorage.setItem('settings', JSON.stringify(settings));
                loadSettings();
                alert('Settings saved successfully');
            }
            
            // Update admin password if provided
            if (adminPassword) {
                const adminUser = users.find(u => u.role === 'admin');
                if (adminUser) {
                    adminUser.password = adminPassword;
                    localStorage.setItem('users', JSON.stringify(users));
                    
                    // Update current user if it's the admin
                    if (currentUser.role === 'admin') {
                        currentUser.password = adminPassword;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                }
            }
        }

        // Handle create backup
        function handleCreateBackup() {
            const backupData = {
                vehicles,
                customers,
                rentals,
                returns,
                maintenance,
                payments,
                fines,
                users,
                settings,
                timestamp: new Date().toISOString()
            };
            
            const backupBlob = new Blob([JSON.stringify(backupData)], { type: 'application/json' });
            const backupUrl = URL.createObjectURL(backupBlob);
            
            const a = document.createElement('a');
            a.href = backupUrl;
            a.download = `car_rental_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            alert('Backup created successfully');
        }

        // Handle restore backup
        function handleRestoreBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // Restore data
                        vehicles = backupData.vehicles || [];
                        customers = backupData.customers || [];
                        rentals = backupData.rentals || [];
                        returns = backupData.returns || [];
                        maintenance = backupData.maintenance || [];
                        payments = backupData.payments || [];
                        fines = backupData.fines || [];
                        users = backupData.users || [{ username: 'admin', password: '000000', role: 'admin' }];
                        settings = backupData.settings || { systemName: 'Car Rental System', currency: 'AED', dateFormat: 'dd/mm/yyyy' };
                        
                        // Save to localStorage
                        localStorage.setItem('vehicles', JSON.stringify(vehicles));
                        localStorage.setItem('customers', JSON.stringify(customers));
                        localStorage.setItem('rentals', JSON.stringify(rentals));
                        localStorage.setItem('returns', JSON.stringify(returns));
                        localStorage.setItem('maintenance', JSON.stringify(maintenance));
                        localStorage.setItem('payments', JSON.stringify(payments));
                        localStorage.setItem('fines', JSON.stringify(fines));
                        localStorage.setItem('users', JSON.stringify(users));
                        localStorage.setItem('settings', JSON.stringify(settings));
                        
                        // Reload all data
                        loadDashboardData();
                        loadVehicleData();
                        loadCustomerData();
                        loadRentalData();
                        loadReturnData();
                        loadMaintenanceData();
                        loadPaymentData();
                        loadFinesData();
                        loadUserManagementData();
                        loadSettings();
                        
                        alert('Backup restored successfully');
                    } catch (error) {
                        alert('Error restoring backup: Invalid file format');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Handle add vehicle
        function handleAddVehicle(e) {
            e.preventDefault();
            const name = document.getElementById('vehicleName').value;
            const odometer = parseInt(document.getElementById('vehicleOdometer').value);
            const vin = document.getElementById('vehicleVin').value;
            const plate = document.getElementById('vehiclePlate').value;
            const color = document.getElementById('vehicleColor').value;
            const model = document.getElementById('vehicleModel').value;
            const rentalPrice = parseFloat(document.getElementById('vehicleRentalPrice').value);
            
            // Check if VIN already exists
            if (vehicles.find(v => v.vin === vin)) {
                alert('Vehicle with this VIN already exists');
                return;
            }
            
            // Check if plate number already exists
            if (vehicles.find(v => v.plate === plate)) {
                alert('Vehicle with this plate number already exists');
                return;
            }
            
            const newVehicle = {
                id: generateId(),
                name,
                odometer,
                vin,
                plate,
                color,
                model,
                rentalPrice,
                status: 'Available',
                image: null
            };
            
            // Handle vehicle image
            const imageFile = document.getElementById('vehicleImage').files[0];
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    newVehicle.image = e.target.result;
                    vehicles.push(newVehicle);
                    localStorage.setItem('vehicles', JSON.stringify(vehicles));
                    alert('Vehicle added successfully');
                    document.getElementById('addVehicleForm').reset();
                    loadVehicleData();
                };
                reader.readAsDataURL(imageFile);
            } else {
                vehicles.push(newVehicle);
                localStorage.setItem('vehicles', JSON.stringify(vehicles));
                alert('Vehicle added successfully');
                document.getElementById('addVehicleForm').reset();
                loadVehicleData();
            }
        }

        // Handle vehicle search
        function handleVehicleSearch() {
            const searchTerm = document.getElementById('vehicleSearch').value.toLowerCase();
            const filteredVehicles = vehicles.filter(vehicle => 
                vehicle.name.toLowerCase().includes(searchTerm) ||
                vehicle.plate.toLowerCase().includes(searchTerm) ||
                vehicle.model.toLowerCase().includes(searchTerm) ||
                vehicle.color.toLowerCase().includes(searchTerm)
            );
            displayVehicleTable(filteredVehicles);
        }

        // Handle vehicle history search
        function handleVehicleHistorySearch() {
            const searchTerm = document.getElementById('vehicleHistorySearch').value.toLowerCase();
            const filteredRentals = rentals.filter(rental => 
                rental.vehicleName.toLowerCase().includes(searchTerm)
            );
            displayVehicleHistoryTable(filteredRentals);
        }

        // Handle add customer
        function handleAddCustomer(e) {
            e.preventDefault();
            const fullName = document.getElementById('customerFullName').value;
            const age = parseInt(document.getElementById('customerAge').value);
            const id = document.getElementById('customerId').value;
            const nationality = document.getElementById('customerNationality').value;
            const contact = document.getElementById('customerContact').value;
            const address = document.getElementById('customerAddress').value;
            
            // Check if customer ID already exists
            if (customers.find(c => c.id === id)) {
                alert('Customer with this ID already exists');
                return;
            }
            
            const newCustomer = {
                id: generateId(),
                fullName,
                age,
                idNumber: id,
                nationality,
                contact,
                address,
                guaranteeDoc: null,
                totalDebt: 0
            };
            
            // Handle guarantee document
            const docFile = document.getElementById('guaranteeDoc').files[0];
            if (docFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    newCustomer.guaranteeDoc = e.target.result;
                    customers.push(newCustomer);
                    localStorage.setItem('customers', JSON.stringify(customers));
                    alert('Customer added successfully');
                    document.getElementById('addCustomerForm').reset();
                    loadCustomerData();
                };
                reader.readAsDataURL(docFile);
            } else {
                customers.push(newCustomer);
                localStorage.setItem('customers', JSON.stringify(customers));
                alert('Customer added successfully');
                document.getElementById('addCustomerForm').reset();
                loadCustomerData();
            }
        }

        // Handle customer search
        function handleCustomerSearch() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            const filteredCustomers = customers.filter(customer => 
                customer.fullName.toLowerCase().includes(searchTerm) ||
                customer.idNumber.toLowerCase().includes(searchTerm) ||
                customer.nationality.toLowerCase().includes(searchTerm) ||
                customer.contact.toLowerCase().includes(searchTerm)
            );
            displayCustomerTable(filteredCustomers);
        }

        // Handle create rental
        function handleCreateRental(e) {
            e.preventDefault();
            const customerName = document.getElementById('rentalCustomer').value;
            const vehicleName = document.getElementById('rentalVehicle').value;
            const rentalAmount = parseFloat(document.getElementById('rentalAmount').value);
            const rentalDays = parseInt(document.getElementById('rentalDays').value);
            const startDate = document.getElementById('rentalStartDate').value;
            const endDate = document.getElementById('rentalEndDate').value;
            const invoiceCode = document.getElementById('invoiceCode').value || generateInvoiceCode();
            
            // Find customer and vehicle
            const customer = customers.find(c => c.fullName === customerName);
            const vehicle = vehicles.find(v => v.name === vehicleName);
            
            if (!customer) {
                alert('Customer not found');
                return;
            }
            
            if (!vehicle) {
                alert('Vehicle not found');
                return;
            }
            
            if (vehicle.status !== 'Available') {
                alert('Vehicle is not available for rental');
                return;
            }
            
            const newRental = {
                id: generateId(),
                invoiceCode,
                customerId: customer.id,
                customerName: customer.fullName,
                vehicleId: vehicle.id,
                vehicleName: vehicle.name,
                rentalAmount,
                rentalDays,
                startDate,
                endDate,
                totalAmount: rentalAmount * rentalDays,
                status: 'Active',
                createdDate: new Date().toISOString()
            };
            
            // Update vehicle status
            vehicle.status = 'Rented';
            
            rentals.push(newRental);
            localStorage.setItem('rentals', JSON.stringify(rentals));
            localStorage.setItem('vehicles', JSON.stringify(vehicles));
            
            alert('Rental created successfully');
            document.getElementById('createRentalForm').reset();
            loadRentalData();
            loadVehicleData();
            loadDashboardData();
        }

        // Handle rental search
        function handleRentalSearch() {
            const searchTerm = document.getElementById('rentalSearch').value.toLowerCase();
            const filteredRentals = rentals.filter(rental => 
                rental.invoiceCode.toLowerCase().includes(searchTerm) ||
                rental.customerName.toLowerCase().includes(searchTerm) ||
                rental.vehicleName.toLowerCase().includes(searchTerm)
            );
            displayRentalTable(filteredRentals);
        }

        // Handle search invoice for return
        function handleSearchInvoice() {
            const invoiceCode = document.getElementById('returnInvoiceSearch').value;
            const rental = rentals.find(r => r.invoiceCode === invoiceCode && r.status === 'Active');
            
            if (rental) {
                document.getElementById('returnCustomer').value = rental.customerName;
                document.getElementById('returnVehicle').value = rental.vehicleName;
                document.getElementById('returnStartDate').value = rental.startDate;
                document.getElementById('returnEndDate').value = rental.endDate;
                document.getElementById('returnFormContainer').style.display = 'block';
            } else {
                alert('Active rental with this invoice code not found');
            }
        }

        // Handle return invoice search suggestions
        function handleReturnInvoiceSearch() {
            const searchTerm = document.getElementById('returnInvoiceSearch').value.toLowerCase();
            const filteredRentals = rentals.filter(rental => 
                rental.invoiceCode.toLowerCase().includes(searchTerm) && rental.status === 'Active'
            );
            showSuggestions(document.getElementById('returnInvoiceSearch'), filteredRentals.map(r => r.invoiceCode), 'returnInvoiceSuggestions');
        }

        // Handle return vehicle
        function handleReturnVehicle(e) {
            e.preventDefault();
            const invoiceCode = document.getElementById('returnInvoiceSearch').value;
            const odometer = parseInt(document.getElementById('returnOdometer').value);
            const returnDate = document.getElementById('returnDate').value;
            const returnTime = document.getElementById('returnTime').value;
            const fuelLevel = document.getElementById('returnFuelLevel').value;
            const notes = document.getElementById('returnNotes').value;
            
            const rental = rentals.find(r => r.invoiceCode === invoiceCode && r.status === 'Active');
            if (!rental) {
                alert('Active rental not found');
                return;
            }
            
            const vehicle = vehicles.find(v => v.id === rental.vehicleId);
            if (!vehicle) {
                alert('Vehicle not found');
                return;
            }
            
            // Calculate any additional charges (late return, extra km, etc.)
            const additionalCharges = calculateAdditionalCharges(rental, odometer, returnDate);
            
            const newReturn = {
                id: generateId(),
                rentalId: rental.id,
                invoiceCode: rental.invoiceCode,
                customerId: rental.customerId,
                customerName: rental.customerName,
                vehicleId: rental.vehicleId,
                vehicleName: rental.vehicleName,
                odometer,
                returnDate,
                returnTime,
                fuelLevel,
                notes,
                additionalCharges,
                images: [],
                returnTimestamp: new Date().toISOString()
            };
            
            // Handle return images
            const imageFiles = document.getElementById('returnImages').files;
            if (imageFiles.length > 0) {
                const readers = [];
                for (let i = 0; i < imageFiles.length; i++) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        newReturn.images.push(e.target.result);
                        if (newReturn.images.length === imageFiles.length) {
                            completeReturnProcess(rental, vehicle, newReturn, odometer);
                        }
                    };
                    reader.readAsDataURL(imageFiles[i]);
                }
            } else {
                completeReturnProcess(rental, vehicle, newReturn, odometer);
            }
        }

        // Complete the return process
        function completeReturnProcess(rental, vehicle, returnRecord, odometer) {
            // Update rental status
            rental.status = 'Completed';
            rental.returnRecordId = returnRecord.id;
            
            // Update vehicle status and odometer
            vehicle.status = 'Available';
            vehicle.odometer = odometer;
            
            // Add to returns
            returns.push(returnRecord);
            
            // Save to localStorage
            localStorage.setItem('rentals', JSON.stringify(rentals));
            localStorage.setItem('vehicles', JSON.stringify(vehicles));
            localStorage.setItem('returns', JSON.stringify(returns));
            
            alert('Vehicle return completed successfully');
            document.getElementById('returnVehicleForm').reset();
            document.getElementById('returnFormContainer').style.display = 'none';
            document.getElementById('returnInvoiceSearch').value = '';
            
            loadReturnData();
            loadRentalData();
            loadVehicleData();
            loadDashboardData();
        }

        // Calculate additional charges for vehicle return
        function calculateAdditionalCharges(rental, odometer, returnDate) {
            let charges = 0;
            
            // Calculate late return charges
            const plannedReturn = new Date(rental.endDate);
            const actualReturn = new Date(returnDate);
            const daysLate = Math.max(0, Math.ceil((actualReturn - plannedReturn) / (1000 * 60 * 60 * 24)));
            
            if (daysLate > 0) {
                charges += daysLate * rental.rentalAmount;
            }
            
            // Calculate extra km charges (assuming 0.5 AED per km over 100 km per day)
            const expectedKm = rental.rentalDays * 100;
            const vehicle = vehicles.find(v => v.id === rental.vehicleId);
            if (vehicle) {
                const kmDriven = odometer - vehicle.odometer;
                const extraKm = Math.max(0, kmDriven - expectedKm);
                if (extraKm > 0) {
                    charges += extraKm * 0.5;
                }
            }
            
            return charges;
        }

        // Handle return history search
        function handleReturnHistorySearch() {
            const searchTerm = document.getElementById('returnHistorySearch').value.toLowerCase();
            const filteredReturns = returns.filter(returnRecord => 
                returnRecord.invoiceCode.toLowerCase().includes(searchTerm) ||
                returnRecord.customerName.toLowerCase().includes(searchTerm) ||
                returnRecord.vehicleName.toLowerCase().includes(searchTerm)
            );
            displayReturnHistoryTable(filteredReturns);
        }

        // Handle schedule maintenance
        function handleScheduleMaintenance(e) {
            e.preventDefault();
            const vehicleName = document.getElementById('maintenanceVehicle').value;
            const maintenanceType = document.getElementById('maintenanceType').value;
            const maintenanceDate = document.getElementById('maintenanceDate').value;
            const cost = parseFloat(document.getElementById('maintenanceCost').value);
            const description = document.getElementById('maintenanceDescription').value;
            
            const vehicle = vehicles.find(v => v.name === vehicleName);
            if (!vehicle) {
                alert('Vehicle not found');
                return;
            }
            
            const newMaintenance = {
                id: generateId(),
                vehicleId: vehicle.id,
                vehicleName: vehicle.name,
                maintenanceType,
                maintenanceDate,
                cost,
                description,
                status: 'Scheduled',
                createdDate: new Date().toISOString()
            };
            
            maintenance.push(newMaintenance);
            localStorage.setItem('maintenance', JSON.stringify(maintenance));
            
            alert('Maintenance scheduled successfully');
            document.getElementById('scheduleMaintenanceForm').reset();
            loadMaintenanceData();
        }

        // Handle maintenance search
        function handleMaintenanceSearch() {
            const searchTerm = document.getElementById('maintenanceSearch').value.toLowerCase();
            const filteredMaintenance = maintenance.filter(m => 
                m.vehicleName.toLowerCase().includes(searchTerm) ||
                m.maintenanceType.toLowerCase().includes(searchTerm)
            );
            displayMaintenanceTable(filteredMaintenance);
        }

        // Handle search payment customer
        function handleSearchPaymentCustomer() {
            const customerName = document.getElementById('paymentCustomerSearch').value;
            const customer = customers.find(c => c.fullName === customerName);
            
            if (customer) {
                document.getElementById('paymentCustomerName').textContent = customer.fullName;
                document.getElementById('paymentCustomerId').textContent = customer.idNumber;
                document.getElementById('paymentCustomerContact').textContent = customer.contact;
                document.getElementById('paymentCustomerIdInput').value = customer.id;
                
                // Calculate debt
                const rentalDebt = calculateRentalDebt(customer.id);
                const finesDebt = calculateFinesDebt(customer.id);
                const totalDebt = rentalDebt + finesDebt;
                
                document.getElementById('paymentRentalDebt').textContent = rentalDebt.toFixed(2);
                document.getElementById('paymentFinesDebt').textContent = finesDebt.toFixed(2);
                document.getElementById('paymentTotalDebt').textContent = totalDebt.toFixed(2);
                
                document.getElementById('paymentDetailsContainer').style.display = 'block';
            } else {
                alert('Customer not found');
            }
        }

        // Handle payment customer search suggestions
        function handlePaymentCustomerSearch() {
            const searchTerm = document.getElementById('paymentCustomerSearch').value.toLowerCase();
            const filteredCustomers = customers.filter(customer => 
                customer.fullName.toLowerCase().includes(searchTerm)
            );
            showSuggestions(document.getElementById('paymentCustomerSearch'), filteredCustomers.map(c => c.fullName), 'paymentCustomerSuggestions');
        }

        // Calculate rental debt for a customer
        function calculateRentalDebt(customerId) {
            const customerRentals = rentals.filter(r => r.customerId === customerId && r.status === 'Completed');
            let totalRentalAmount = 0;
            
            customerRentals.forEach(rental => {
                totalRentalAmount += rental.totalAmount;
                
                // Add additional charges from returns
                const returnRecord = returns.find(ret => ret.rentalId === rental.id);
                if (returnRecord) {
                    totalRentalAmount += returnRecord.additionalCharges;
                }
            });
            
            // Subtract payments
            const customerPayments = payments.filter(p => p.customerId === customerId);
            const totalPayments = customerPayments.reduce((sum, payment) => sum + payment.amount, 0);
            
            return Math.max(0, totalRentalAmount - totalPayments);
        }

        // Calculate fines debt for a customer
        function calculateFinesDebt(customerId) {
            const customerFines = fines.filter(f => f.customerId === customerId && f.status === 'Unpaid');
            return customerFines.reduce((sum, fine) => sum + fine.amount, 0);
        }

        // Handle process payment
        function handleProcessPayment(e) {
            e.preventDefault();
            const customerId = document.getElementById('paymentCustomerIdInput').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentTime = document.getElementById('paymentTime').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const notes = document.getElementById('paymentNotes').value;
            
            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                alert('Customer not found');
                return;
            }
            
            const newPayment = {
                id: generateId(),
                customerId,
                customerName: customer.fullName,
                amount,
                paymentDate,
                paymentTime,
                paymentMethod,
                notes,
                timestamp: new Date().toISOString()
            };
            
            payments.push(newPayment);
            localStorage.setItem('payments', JSON.stringify(payments));
            
            // Update fines status if payment covers fines
            updateFinesStatus(customerId, amount);
            
            alert('Payment processed successfully');
            document.getElementById('processPaymentForm').reset();
            document.getElementById('paymentDetailsContainer').style.display = 'none';
            document.getElementById('paymentCustomerSearch').value = '';
            
            loadPaymentData();
            loadCustomerData();
            loadDashboardData();
        }

        // Update fines status based on payment
        function updateFinesStatus(customerId, paymentAmount) {
            const customerFines = fines.filter(f => f.customerId === customerId && f.status === 'Unpaid');
            let remainingAmount = paymentAmount;
            
            for (const fine of customerFines) {
                if (remainingAmount <= 0) break;
                
                if (remainingAmount >= fine.amount) {
                    fine.status = 'Paid';
                    remainingAmount -= fine.amount;
                } else {
                    // Partial payment - we could implement this if needed
                    break;
                }
            }
            
            localStorage.setItem('fines', JSON.stringify(fines));
        }

        // Handle payment history search
        function handlePaymentHistorySearch() {
            const searchTerm = document.getElementById('paymentHistorySearch').value.toLowerCase();
            const filteredPayments = payments.filter(payment => 
                payment.customerName.toLowerCase().includes(searchTerm)
            );
            displayPaymentHistoryTable(filteredPayments);
        }

        // Handle add fine
        function handleAddFine(e) {
            e.preventDefault();
            const customerName = document.getElementById('fineCustomer').value;
            const fineType = document.getElementById('fineType').value;
            const amount = parseFloat(document.getElementById('fineAmount').value);
            const fineDate = document.getElementById('fineDate').value;
            const description = document.getElementById('fineDescription').value;
            
            const customer = customers.find(c => c.fullName === customerName);
            if (!customer) {
                alert('Customer not found');
                return;
            }
            
            const newFine = {
                id: generateId(),
                customerId: customer.id,
                customerName: customer.fullName,
                fineType,
                amount,
                fineDate,
                description,
                status: 'Unpaid',
                createdDate: new Date().toISOString()
            };
            
            fines.push(newFine);
            localStorage.setItem('fines', JSON.stringify(fines));
            
            alert('Fine added successfully');
            document.getElementById('addFineForm').reset();
            loadFinesData();
        }

        // Handle fines search
        function handleFinesSearch() {
            const searchTerm = document.getElementById('finesSearch').value.toLowerCase();
            const filteredFines = fines.filter(fine => 
                fine.customerName.toLowerCase().includes(searchTerm) ||
                fine.fineType.toLowerCase().includes(searchTerm)
            );
            displayFinesTable(filteredFines);
        }

        // Handle generate report
        function handleGenerateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            let reportData = '';
            
            switch (reportType) {
                case 'rental':
                    reportData = generateRentalReport(startDate, endDate);
                    break;
                case 'financial':
                    reportData = generateFinancialReport(startDate, endDate);
                    break;
                case 'vehicle':
                    reportData = generateVehicleReport();
                    break;
                case 'customer':
                    reportData = generateCustomerReport();
                    break;
            }
            
            document.getElementById('reportResults').innerHTML = reportData;
        }

        // Handle export report
        function handleExportReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            let csvContent = '';
            
            switch (reportType) {
                case 'rental':
                    csvContent = exportRentalReportToCSV(startDate, endDate);
                    break;
                case 'financial':
                    csvContent = exportFinancialReportToCSV(startDate, endDate);
                    break;
                case 'vehicle':
                    csvContent = exportVehicleReportToCSV();
                    break;
                case 'customer':
                    csvContent = exportCustomerReportToCSV();
                    break;
            }
            
            if (csvContent) {
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${reportType}_report_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }

        // Load dashboard data
        function loadDashboardData() {
            // Calculate statistics
            const totalVehicles = vehicles.length;
            const availableVehicles = vehicles.filter(v => v.status === 'Available').length;
            const rentedVehicles = vehicles.filter(v => v.status === 'Rented').length;
            const totalCustomers = customers.length;
            const activeRentals = rentals.filter(r => r.status === 'Active').length;
            const totalRevenue = payments.reduce((sum, payment) => sum + payment.amount, 0);
            
            // Update dashboard stats
            document.getElementById('dashboardStats').innerHTML = `
                <div class="col-md-3">
                    <div class="card dashboard-card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${totalVehicles}</h4>
                                    <p>Total Vehicles</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-car fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card dashboard-card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${availableVehicles}</h4>
                                    <p>Available Vehicles</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card dashboard-card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${rentedVehicles}</h4>
                                    <p>Rented Vehicles</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-road fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card dashboard-card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${totalCustomers}</h4>
                                    <p>Total Customers</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load recent rentals
            const recentRentals = rentals.slice(-5).reverse();
            let recentRentalsHTML = '';
            recentRentals.forEach(rental => {
                const statusClass = rental.status === 'Active' ? 'status-not-returned' : 'status-returned';
                recentRentalsHTML += `
                    <tr class="${statusClass}">
                        <td>${rental.customerName}</td>
                        <td>${rental.vehicleName}</td>
                        <td>${formatDate(rental.startDate)}</td>
                        <td>${rental.totalAmount} AED</td>
                        <td>${rental.status}</td>
                    </tr>
                `;
            });
            document.getElementById('recentRentalsTable').innerHTML = recentRentalsHTML;
            
            // Load vehicle status chart
            loadVehicleStatusChart();
        }

        // Load vehicle status chart
        function loadVehicleStatusChart() {
            const ctx = document.getElementById('vehicleStatusChart').getContext('2d');
            const availableCount = vehicles.filter(v => v.status === 'Available').length;
            const rentedCount = vehicles.filter(v => v.status === 'Rented').length;
            const maintenanceCount = vehicles.filter(v => v.status === 'Maintenance').length;
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Available', 'Rented', 'Maintenance'],
                    datasets: [{
                        data: [availableCount, rentedCount, maintenanceCount],
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Load vehicle data
        function loadVehicleData() {
            displayVehicleTable(vehicles);
            displayVehicleHistoryTable(rentals);
        }

        // Display vehicle table
        function displayVehicleTable(vehiclesToDisplay) {
            let vehicleTableHTML = '';
            vehiclesToDisplay.forEach(vehicle => {
                const statusClass = vehicle.status === 'Available' ? 'text-success' : 
                                  vehicle.status === 'Rented' ? 'text-warning' : 'text-danger';
                
                vehicleTableHTML += `
                    <tr>
                        <td>
                            ${vehicle.image ? `<img src="${vehicle.image}" class="vehicle-image" alt="${vehicle.name}">` : '<i class="fas fa-car fa-2x text-muted"></i>'}
                        </td>
                        <td>${vehicle.name}</td>
                        <td>${vehicle.model}</td>
                        <td>${vehicle.color}</td>
                        <td>${vehicle.plate}</td>
                        <td>${vehicle.odometer} km</td>
                        <td>${vehicle.rentalPrice} AED</td>
                        <td><span class="${statusClass}">${vehicle.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary view-vehicle" data-id="${vehicle.id}">View</button>
                            ${currentUser.role === 'admin' ? `
                                <button class="btn btn-sm btn-warning edit-vehicle" data-id="${vehicle.id}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-vehicle" data-id="${vehicle.id}">Delete</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('vehicleTableBody').innerHTML = vehicleTableHTML;
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-vehicle').forEach(button => {
                button.addEventListener('click', function() {
                    const vehicleId = this.getAttribute('data-id');
                    viewVehicleDetails(vehicleId);
                });
            });
            
            // Add event listeners to edit buttons (admin only)
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.edit-vehicle').forEach(button => {
                    button.addEventListener('click', function() {
                        const vehicleId = this.getAttribute('data-id');
                        editVehicle(vehicleId);
                    });
                });
                
                document.querySelectorAll('.delete-vehicle').forEach(button => {
                    button.addEventListener('click', function() {
                        const vehicleId = this.getAttribute('data-id');
                        deleteVehicle(vehicleId);
                    });
                });
            }
        }

        // View vehicle details
        function viewVehicleDetails(vehicleId) {
            const vehicle = vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            const vehicleRentals = rentals.filter(r => r.vehicleId === vehicleId);
            const vehicleReturns = returns.filter(r => r.vehicleId === vehicleId);
            const vehicleMaintenance = maintenance.filter(m => m.vehicleId === vehicleId);
            
            let detailsHTML = `
                <div class="row">
                    <div class="col-md-4">
                        ${vehicle.image ? `<img src="${vehicle.image}" class="img-fluid" alt="${vehicle.name}">` : '<i class="fas fa-car fa-5x text-muted"></i>'}
                    </div>
                    <div class="col-md-8">
                        <h4>${vehicle.name}</h4>
                        <p><strong>Model:</strong> ${vehicle.model}</p>
                        <p><strong>Color:</strong> ${vehicle.color}</p>
                        <p><strong>Plate Number:</strong> ${vehicle.plate}</p>
                        <p><strong>VIN:</strong> ${vehicle.vin}</p>
                        <p><strong>Odometer:</strong> ${vehicle.odometer} km</p>
                        <p><strong>Rental Price:</strong> ${vehicle.rentalPrice} AED/day</p>
                        <p><strong>Status:</strong> ${vehicle.status}</p>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h5>Rental History</h5>
                        <ul class="list-group">
                            ${vehicleRentals.map(rental => `
                                <li class="list-group-item">
                                    ${rental.customerName} - ${formatDate(rental.startDate)} to ${formatDate(rental.endDate)}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5>Maintenance History</h5>
                        <ul class="list-group">
                            ${vehicleMaintenance.map(maint => `
                                <li class="list-group-item">
                                    ${maint.maintenanceType} - ${formatDate(maint.maintenanceDate)} - ${maint.cost} AED
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('vehicleDetailsContent').innerHTML = detailsHTML;
            document.getElementById('vehicleDetailsCard').style.display = 'block';
        }

        // Edit vehicle (admin only)
        function editVehicle(vehicleId) {
            const vehicle = vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            // In a real application, you would show a modal with a form to edit the vehicle
            // For this example, we'll just show a prompt for the rental price
            const newPrice = prompt(`Enter new rental price for ${vehicle.name}:`, vehicle.rentalPrice);
            if (newPrice && !isNaN(newPrice)) {
                vehicle.rentalPrice = parseFloat(newPrice);
                localStorage.setItem('vehicles', JSON.stringify(vehicles));
                loadVehicleData();
                alert('Vehicle updated successfully');
            }
        }

        // Delete vehicle (admin only)
        function deleteVehicle(vehicleId) {
            if (!confirm('Are you sure you want to delete this vehicle?')) return;
            
            const vehicleIndex = vehicles.findIndex(v => v.id === vehicleId);
            if (vehicleIndex !== -1) {
                // Check if vehicle is currently rented
                const activeRental = rentals.find(r => r.vehicleId === vehicleId && r.status === 'Active');
                if (activeRental) {
                    alert('Cannot delete vehicle that is currently rented');
                    return;
                }
                
                vehicles.splice(vehicleIndex, 1);
                localStorage.setItem('vehicles', JSON.stringify(vehicles));
                loadVehicleData();
                loadDashboardData();
                alert('Vehicle deleted successfully');
            }
        }

        // Display vehicle history table
        function displayVehicleHistoryTable(rentalsToDisplay) {
            let vehicleHistoryHTML = '';
            rentalsToDisplay.forEach(rental => {
                const statusClass = rental.status === 'Active' ? 'status-not-returned' : 'status-returned';
                
                vehicleHistoryHTML += `
                    <tr class="${statusClass}">
                        <td>${rental.vehicleName}</td>
                        <td>${rental.customerName}</td>
                        <td>${formatDate(rental.startDate)}</td>
                        <td>${formatDate(rental.endDate)}</td>
                        <td>${rental.totalAmount} AED</td>
                        <td>${rental.status}</td>
                    </tr>
                `;
            });
            
            document.getElementById('vehicleHistoryTableBody').innerHTML = vehicleHistoryHTML;
        }

        // Load customer data
        function loadCustomerData() {
            displayCustomerTable(customers);
        }

        // Display customer table
        function displayCustomerTable(customersToDisplay) {
            let customerTableHTML = '';
            customersToDisplay.forEach(customer => {
                // Calculate total debt for customer
                const rentalDebt = calculateRentalDebt(customer.id);
                const finesDebt = calculateFinesDebt(customer.id);
                const totalDebt = rentalDebt + finesDebt;
                
                customerTableHTML += `
                    <tr>
                        <td>${customer.fullName}</td>
                        <td>${customer.age}</td>
                        <td>${customer.idNumber}</td>
                        <td>${customer.nationality}</td>
                        <td>${customer.contact}</td>
                        <td>${totalDebt.toFixed(2)} AED</td>
                        <td>
                            <button class="btn btn-sm btn-primary view-customer" data-id="${customer.id}">View</button>
                            ${currentUser.role === 'admin' ? `
                                <button class="btn btn-sm btn-warning edit-customer" data-id="${customer.id}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-customer" data-id="${customer.id}">Delete</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('customerTableBody').innerHTML = customerTableHTML;
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-customer').forEach(button => {
                button.addEventListener('click', function() {
                    const customerId = this.getAttribute('data-id');
                    viewCustomerDetails(customerId);
                });
            });
            
            // Add event listeners to edit buttons (admin only)
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.edit-customer').forEach(button => {
                    button.addEventListener('click', function() {
                        const customerId = this.getAttribute('data-id');
                        editCustomer(customerId);
                    });
                });
                
                document.querySelectorAll('.delete-customer').forEach(button => {
                    button.addEventListener('click', function() {
                        const customerId = this.getAttribute('data-id');
                        deleteCustomer(customerId);
                    });
                });
            }
        }

        // View customer details
        function viewCustomerDetails(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            const customerRentals = rentals.filter(r => r.customerId === customerId);
            const customerFines = fines.filter(f => f.customerId === customerId);
            const customerPayments = payments.filter(p => p.customerId === customerId);
            
            const rentalDebt = calculateRentalDebt(customerId);
            const finesDebt = calculateFinesDebt(customerId);
            const totalDebt = rentalDebt + finesDebt;
            
            let detailsHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h4>${customer.fullName}</h4>
                        <p><strong>Age:</strong> ${customer.age}</p>
                        <p><strong>ID:</strong> ${customer.idNumber}</p>
                        <p><strong>Nationality:</strong> ${customer.nationality}</p>
                        <p><strong>Contact:</strong> ${customer.contact}</p>
                        <p><strong>Address:</strong> ${customer.address}</p>
                        ${customer.guaranteeDoc ? `<p><strong>Guarantee Document:</strong> <a href="${customer.guaranteeDoc}" target="_blank">View Document</a></p>` : ''}
                    </div>
                    <div class="col-md-6">
                        <h5>Debt Summary</h5>
                        <p><strong>Rental Debt:</strong> ${rentalDebt.toFixed(2)} AED</p>
                        <p><strong>Fines Debt:</strong> ${finesDebt.toFixed(2)} AED</p>
                        <p><strong>Total Debt:</strong> ${totalDebt.toFixed(2)} AED</p>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h5>Rental History</h5>
                        <ul class="list-group">
                            ${customerRentals.map(rental => `
                                <li class="list-group-item">
                                    ${rental.vehicleName} - ${formatDate(rental.startDate)} to ${formatDate(rental.endDate)} - ${rental.totalAmount} AED
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5>Fines History</h5>
                        <ul class="list-group">
                            ${customerFines.map(fine => `
                                <li class="list-group-item">
                                    ${fine.fineType} - ${formatDate(fine.fineDate)} - ${fine.amount} AED - ${fine.status}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('customerDetailsContent').innerHTML = detailsHTML;
            document.getElementById('customerDetailsCard').style.display = 'block';
        }

        // Edit customer (admin only)
        function editCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            // In a real application, you would show a modal with a form to edit the customer
            // For this example, we'll just show a prompt for the contact number
            const newContact = prompt(`Enter new contact number for ${customer.fullName}:`, customer.contact);
            if (newContact) {
                customer.contact = newContact;
                localStorage.setItem('customers', JSON.stringify(customers));
                loadCustomerData();
                alert('Customer updated successfully');
            }
        }

        // Delete customer (admin only)
        function deleteCustomer(customerId) {
            if (!confirm('Are you sure you want to delete this customer?')) return;
            
            const customerIndex = customers.findIndex(c => c.id === customerId);
            if (customerIndex !== -1) {
                // Check if customer has active rentals
                const activeRental = rentals.find(r => r.customerId === customerId && r.status === 'Active');
                if (activeRental) {
                    alert('Cannot delete customer with active rentals');
                    return;
                }
                
                customers.splice(customerIndex, 1);
                localStorage.setItem('customers', JSON.stringify(customers));
                loadCustomerData();
                alert('Customer deleted successfully');
            }
        }

        // Load rental data
        function loadRentalData() {
            displayRentalTable(rentals);
        }

        // Display rental table
        function displayRentalTable(rentalsToDisplay) {
            let rentalTableHTML = '';
            rentalsToDisplay.forEach(rental => {
                const statusClass = rental.status === 'Active' ? 'status-not-returned' : 'status-returned';
                
                rentalTableHTML += `
                    <tr class="${statusClass}">
                        <td>${rental.invoiceCode}</td>
                        <td>${rental.customerName}</td>
                        <td>${rental.vehicleName}</td>
                        <td>${formatDate(rental.startDate)}</td>
                        <td>${formatDate(rental.endDate)}</td>
                        <td>${rental.totalAmount} AED</td>
                        <td>${rental.status}</td>
                        <td>
                            <button class="btn btn-sm btn-primary print-invoice" data-id="${rental.id}">Print</button>
                            ${currentUser.role === 'admin' && rental.status === 'Active' ? `
                                <button class="btn btn-sm btn-danger cancel-rental" data-id="${rental.id}">Cancel</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('rentalTableBody').innerHTML = rentalTableHTML;
            
            // Add event listeners to print buttons
            document.querySelectorAll('.print-invoice').forEach(button => {
                button.addEventListener('click', function() {
                    const rentalId = this.getAttribute('data-id');
                    printInvoice(rentalId);
                });
            });
            
            // Add event listeners to cancel buttons (admin only)
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.cancel-rental').forEach(button => {
                    button.addEventListener('click', function() {
                        const rentalId = this.getAttribute('data-id');
                        cancelRental(rentalId);
                    });
                });
            }
        }

        // Print invoice
        function printInvoice(rentalId) {
            const rental = rentals.find(r => r.id === rentalId);
            if (!rental) return;
            
            const customer = customers.find(c => c.id === rental.customerId);
            if (!customer) return;
            
            // Update print content
            document.getElementById('printInvoiceCode').textContent = rental.invoiceCode;
            document.getElementById('printInvoiceDate').textContent = formatDate(rental.createdDate);
            document.getElementById('printCustomerName').textContent = rental.customerName;
            document.getElementById('printVehicleName').textContent = rental.vehicleName;
            document.getElementById('printCustomerId').textContent = customer.idNumber;
            document.getElementById('printCustomerAddress').textContent = customer.address;
            document.getElementById('printRentalAmount').textContent = rental.rentalAmount + ' AED';
            document.getElementById('printRentalDays').textContent = rental.rentalDays;
            document.getElementById('printTotalAmount').textContent = rental.totalAmount + ' AED';
            
            // Set system name and logo for printing
            document.getElementById('printSystemName').textContent = settings.systemName;
            if (settings.logo) {
                document.getElementById('printLogo').src = settings.logo;
                document.getElementById('printLogo').style.display = 'block';
            }
            
            // Show rental history in print
            const rentalHistory = rentals.filter(r => r.customerId === rental.customerId);
            let rentalHistoryHTML = '<ul>';
            rentalHistory.forEach(r => {
                rentalHistoryHTML += `<li>${r.vehicleName} - ${formatDate(r.startDate)} to ${formatDate(r.endDate)} - ${r.totalAmount} AED</li>`;
            });
            rentalHistoryHTML += '</ul>';
            document.getElementById('printRentalHistory').innerHTML = rentalHistoryHTML;
            
            // Print the invoice
            window.print();
        }

        // Cancel rental (admin only)
        function cancelRental(rentalId) {
            if (!confirm('Are you sure you want to cancel this rental?')) return;
            
            const rental = rentals.find(r => r.id === rentalId);
            if (!rental) return;
            
            // Update vehicle status
            const vehicle = vehicles.find(v => v.id === rental.vehicleId);
            if (vehicle) {
                vehicle.status = 'Available';
            }
            
            // Update rental status
            rental.status = 'Cancelled';
            
            localStorage.setItem('rentals', JSON.stringify(rentals));
            localStorage.setItem('vehicles', JSON.stringify(vehicles));
            loadRentalData();
            loadVehicleData();
            loadDashboardData();
            alert('Rental cancelled successfully');
        }

        // Load return data
        function loadReturnData() {
            displayReturnHistoryTable(returns);
        }

        // Display return history table
        function displayReturnHistoryTable(returnsToDisplay) {
            let returnHistoryHTML = '';
            returnsToDisplay.forEach(returnRecord => {
                returnHistoryHTML += `
                    <tr>
                        <td>${returnRecord.invoiceCode}</td>
                        <td>${returnRecord.customerName}</td>
                        <td>${returnRecord.vehicleName}</td>
                        <td>${formatDate(returnRecord.returnDate)}</td>
                        <td>${returnRecord.odometer} km</td>
                        <td>${returnRecord.fuelLevel}</td>
                        <td>
                            <button class="btn btn-sm btn-primary view-return" data-id="${returnRecord.id}">View</button>
                            ${currentUser.role === 'admin' ? `
                                <button class="btn btn-sm btn-danger delete-return" data-id="${returnRecord.id}">Delete</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('returnHistoryTableBody').innerHTML = returnHistoryHTML;
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-return').forEach(button => {
                button.addEventListener('click', function() {
                    const returnId = this.getAttribute('data-id');
                    viewReturnDetails(returnId);
                });
            });
            
            // Add event listeners to delete buttons (admin only)
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.delete-return').forEach(button => {
                    button.addEventListener('click', function() {
                        const returnId = this.getAttribute('data-id');
                        deleteReturn(returnId);
                    });
                });
            }
        }

        // View return details
        function viewReturnDetails(returnId) {
            const returnRecord = returns.find(r => r.id === returnId);
            if (!returnRecord) return;
            
            const rental = rentals.find(r => r.id === returnRecord.rentalId);
            
            let detailsHTML = `
                <h5>Return Details</h5>
                <p><strong>Invoice Code:</strong> ${returnRecord.invoiceCode}</p>
                <p><strong>Customer:</strong> ${returnRecord.customerName}</p>
                <p><strong>Vehicle:</strong> ${returnRecord.vehicleName}</p>
                <p><strong>Return Date:</strong> ${formatDate(returnRecord.returnDate)}</p>
                <p><strong>Return Time:</strong> ${returnRecord.returnTime}</p>
                <p><strong>Odometer:</strong> ${returnRecord.odometer} km</p>
                <p><strong>Fuel Level:</strong> ${returnRecord.fuelLevel}</p>
                <p><strong>Additional Charges:</strong> ${returnRecord.additionalCharges} AED</p>
                <p><strong>Notes:</strong> ${returnRecord.notes}</p>
            `;
            
            if (returnRecord.images.length > 0) {
                detailsHTML += `<p><strong>Images:</strong></p>`;
                returnRecord.images.forEach(image => {
                    detailsHTML += `<img src="${image}" class="img-thumbnail m-1" style="max-width: 200px;">`;
                });
            }
            
            if (rental) {
                detailsHTML += `
                    <h5 class="mt-3">Rental Details</h5>
                    <p><strong>Rental Period:</strong> ${formatDate(rental.startDate)} to ${formatDate(rental.endDate)}</p>
                    <p><strong>Rental Amount:</strong> ${rental.totalAmount} AED</p>
                `;
            }
            
            alert(detailsHTML); // In a real application, you would show this in a modal
        }

        // Delete return (admin only)
        function deleteReturn(returnId) {
            if (!confirm('Are you sure you want to delete this return record?')) return;
            
            const returnIndex = returns.findIndex(r => r.id === returnId);
            if (returnIndex !== -1) {
                returns.splice(returnIndex, 1);
                localStorage.setItem('returns', JSON.stringify(returns));
                loadReturnData();
                alert('Return record deleted successfully');
            }
        }

        // Load maintenance data
        function loadMaintenanceData() {
            displayMaintenanceTable(maintenance);
        }

        // Display maintenance table
        function displayMaintenanceTable(maintenanceToDisplay) {
            let maintenanceHTML = '';
            maintenanceToDisplay.forEach(maint => {
                const statusClass = maint.status === 'Scheduled' ? 'text-warning' : 
                                   maint.status === 'Completed' ? 'text-success' : 'text-danger';
                
                maintenanceHTML += `
                    <tr>
                        <td>${maint.vehicleName}</td>
                        <td>${maint.maintenanceType}</td>
                        <td>${formatDate(maint.maintenanceDate)}</td>
                        <td>${maint.cost} AED</td>
                        <td><span class="${statusClass}">${maint.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary view-maintenance" data-id="${maint.id}">View</button>
                            ${currentUser.role === 'admin' ? `
                                <button class="btn btn-sm btn-warning edit-maintenance" data-id="${maint.id}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-maintenance" data-id="${maint.id}">Delete</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('maintenanceTableBody').innerHTML = maintenanceHTML;
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-maintenance').forEach(button => {
                button.addEventListener('click', function() {
                    const maintenanceId = this.getAttribute('data-id');
                    viewMaintenanceDetails(maintenanceId);
                });
            });
            
            // Add event listeners to edit buttons (admin only)
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.edit-maintenance').forEach(button => {
                    button.addEventListener('click', function() {
                        const maintenanceId = this.getAttribute('data-id');
                        editMaintenance(maintenanceId);
                    });
                });
                
                document.querySelectorAll('.delete-maintenance').forEach(button => {
                    button.addEventListener('click', function() {
                        const maintenanceId = this.getAttribute('data-id');
                        deleteMaintenance(maintenanceId);
                    });
                });
            }
        }

        // View maintenance details
        function viewMaintenanceDetails(maintenanceId) {
            const maint = maintenance.find(m => m.id === maintenanceId);
            if (!maint) return;
            
            let detailsHTML = `
                <h5>Maintenance Details</h5>
                <p><strong>Vehicle:</strong> ${maint.vehicleName}</p>
                <p><strong>Maintenance Type:</strong> ${maint.maintenanceType}</p>
                <p><strong>Maintenance Date:</strong> ${formatDate(maint.maintenanceDate)}</p>
                <p><strong>Cost:</strong> ${maint.cost} AED</p>
                <p><strong>Status:</strong> ${maint.status}</p>
                <p><strong>Description:</strong> ${maint.description}</p>
            `;
            
            alert(detailsHTML); // In a real application, you would show this in a modal
        }

        // Edit maintenance (admin only)
        function editMaintenance(maintenanceId) {
            const maint = maintenance.find(m => m.id === maintenanceId);
            if (!maint) return;
            
            // In a real application, you would show a modal with a form to edit the maintenance
            // For this example, we'll just show a prompt for the status
            const newStatus = prompt(`Enter new status for maintenance (Scheduled/Completed/Cancelled):`, maint.status);
            if (newStatus && ['Scheduled', 'Completed', 'Cancelled'].includes(newStatus)) {
                maint.status = newStatus;
                localStorage.setItem('maintenance', JSON.stringify(maintenance));
                loadMaintenanceData();
                alert('Maintenance updated successfully');
            }
        }

        // Delete maintenance (admin only)
        function deleteMaintenance(maintenanceId) {
            if (!confirm('Are you sure you want to delete this maintenance record?')) return;
            
            const maintenanceIndex = maintenance.findIndex(m => m.id === maintenanceId);
            if (maintenanceIndex !== -1) {
                maintenance.splice(maintenanceIndex, 1);
                localStorage.setItem('maintenance', JSON.stringify(maintenance));
                loadMaintenanceData();
                alert('Maintenance record deleted successfully');
            }
        }

        // Load payment data
        function loadPaymentData() {
            displayPaymentHistoryTable(payments);
        }

        // Display payment history table
        function displayPaymentHistoryTable(paymentsToDisplay) {
            let paymentHistoryHTML = '';
            paymentsToDisplay.forEach(payment => {
                paymentHistoryHTML += `
                    <tr>
                        <td>${payment.customerName}</td>
                        <td>${formatDate(payment.paymentDate)}</td>
                        <td>${payment.paymentTime}</td>
                        <td>${payment.amount} AED</td>
                        <td>${payment.paymentMethod}</td>
                        <td>
                            <button class="btn btn-sm btn-primary view-payment" data-id="${payment.id}">View</button>
                            ${currentUser.role === 'admin' ? `
                                <button class="btn btn-sm btn-danger delete-payment" data-id="${payment.id}">Delete</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('paymentHistoryTableBody').innerHTML = paymentHistoryHTML;
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-payment').forEach(button => {
                button.addEventListener('click', function() {
                    const paymentId = this.getAttribute('data-id');
                    viewPaymentDetails(paymentId);
                });
            });
            
            // Add event listeners to delete buttons (admin only)
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.delete-payment').forEach(button => {
                    button.addEventListener('click', function() {
                        const paymentId = this.getAttribute('data-id');
                        deletePayment(paymentId);
                    });
                });
            }
        }

        // View payment details
        function viewPaymentDetails(paymentId) {
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) return;
            
            let detailsHTML = `
                <h5>Payment Details</h5>
                <p><strong>Customer:</strong> ${payment.customerName}</p>
                <p><strong>Payment Date:</strong> ${formatDate(payment.paymentDate)}</p>
                <p><strong>Payment Time:</strong> ${payment.paymentTime}</p>
                <p><strong>Amount:</strong> ${payment.amount} AED</p>
                <p><strong>Payment Method:</strong> ${payment.paymentMethod}</p>
                <p><strong>Notes:</strong> ${payment.notes}</p>
            `;
            
            alert(detailsHTML); // In a real application, you would show this in a modal
        }

        // Delete payment (admin only)
        function deletePayment(paymentId) {
            if (!confirm('Are you sure you want to delete this payment record?')) return;
            
            const paymentIndex = payments.findIndex(p => p.id === paymentId);
            if (paymentIndex !== -1) {
                payments.splice(paymentIndex, 1);
                localStorage.setItem('payments', JSON.stringify(payments));
                loadPaymentData();
                alert('Payment record deleted successfully');
            }
        }

        // Load fines data
        function loadFinesData() {
            displayFinesTable(fines);
        }

        // Display fines table
        function displayFinesTable(finesToDisplay) {
            let finesHTML = '';
            finesToDisplay.forEach(fine => {
                const statusClass = fine.status === 'Paid' ? 'text-success' : 'text-danger';
                
                finesHTML += `
                    <tr>
                        <td>${fine.customerName}</td>
                        <td>${fine.fineType}</td>
                        <td>${formatDate(fine.fineDate)}</td>
                        <td>${fine.amount} AED</td>
                        <td>${fine.description}</td>
                        <td><span class="${statusClass}">${fine.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary view-fine" data-id="${fine.id}">View</button>
                            ${currentUser.role === 'admin' ? `
                                <button class="btn btn-sm btn-warning edit-fine" data-id="${fine.id}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-fine" data-id="${fine.id}">Delete</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('finesTableBody').innerHTML = finesHTML;
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-fine').forEach(button => {
                button.addEventListener('click', function() {
                    const fineId = this.getAttribute('data-id');
                    viewFineDetails(fineId);
                });
            });
            
            // Add event listeners to edit buttons (admin only)
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.edit-fine').forEach(button => {
                    button.addEventListener('click', function() {
                        const fineId = this.getAttribute('data-id');
                        editFine(fineId);
                    });
                });
                
                document.querySelectorAll('.delete-fine').forEach(button => {
                    button.addEventListener('click', function() {
                        const fineId = this.getAttribute('data-id');
                        deleteFine(fineId);
                    });
                });
            }
        }

        // View fine details
        function viewFineDetails(fineId) {
            const fine = fines.find(f => f.id === fineId);
            if (!fine) return;
            
            let detailsHTML = `
                <h5>Fine Details</h5>
                <p><strong>Customer:</strong> ${fine.customerName}</p>
                <p><strong>Fine Type:</strong> ${fine.fineType}</p>
                <p><strong>Fine Date:</strong> ${formatDate(fine.fineDate)}</p>
                <p><strong>Amount:</strong> ${fine.amount} AED</p>
                <p><strong>Status:</strong> ${fine.status}</p>
                <p><strong>Description:</strong> ${fine.description}</p>
            `;
            
            alert(detailsHTML); // In a real application, you would show this in a modal
        }

        // Edit fine (admin only)
        function editFine(fineId) {
            const fine = fines.find(f => f.id === fineId);
            if (!fine) return;
            
            // In a real application, you would show a modal with a form to edit the fine
            // For this example, we'll just show a prompt for the status
            const newStatus = prompt(`Enter new status for fine (Unpaid/Paid):`, fine.status);
            if (newStatus && ['Unpaid', 'Paid'].includes(newStatus)) {
                fine.status = newStatus;
                localStorage.setItem('fines', JSON.stringify(fines));
                loadFinesData();
                alert('Fine updated successfully');
            }
        }

        // Delete fine (admin only)
        function deleteFine(fineId) {
            if (!confirm('Are you sure you want to delete this fine record?')) return;
            
            const fineIndex = fines.findIndex(f => f.id === fineId);
            if (fineIndex !== -1) {
                fines.splice(fineIndex, 1);
                localStorage.setItem('fines', JSON.stringify(fines));
                loadFinesData();
                alert('Fine record deleted successfully');
            }
        }

        // Load user management data
        function loadUserManagementData() {
            displayUserManagementTable();
        }

        // Display user management table
        function displayUserManagementTable() {
            let userManagementHTML = '';
            users.forEach(user => {
                userManagementHTML += `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.role}</td>
                        <td>${user.role === 'admin' ? 'All permissions' : 'Limited permissions'}</td>
                        <td>
                            ${currentUser.role === 'admin' && user.username !== currentUser.username ? `
                                <button class="btn btn-sm btn-warning edit-user" data-username="${user.username}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-user" data-username="${user.username}">Delete</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('userManagementTable').innerHTML = userManagementHTML;
            document.getElementById('userManagementModalTable').innerHTML = userManagementHTML;
            
            // Add event listeners to edit buttons (admin only)
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.edit-user').forEach(button => {
                    button.addEventListener('click', function() {
                        const username = this.getAttribute('data-username');
                        editUser(username);
                    });
                });
                
                document.querySelectorAll('.delete-user').forEach(button => {
                    button.addEventListener('click', function() {
                        const username = this.getAttribute('data-username');
                        deleteUser(username);
                    });
                });
            }
        }

        // Edit user (admin only)
        function editUser(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            // In a real application, you would show a modal with a form to edit the user
            // For this example, we'll just show a prompt for the role
            const newRole = prompt(`Enter new role for ${username} (admin/viewer):`, user.role);
            if (newRole && ['admin', 'viewer'].includes(newRole)) {
                user.role = newRole;
                localStorage.setItem('users', JSON.stringify(users));
                loadUserManagementData();
                alert('User updated successfully');
            }
        }

        // Delete user (admin only)
        function deleteUser(username) {
            if (username === currentUser.username) {
                alert('You cannot delete your own account');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete user ${username}?`)) return;
            
            const userIndex = users.findIndex(u => u.username === username);
            if (userIndex !== -1) {
                users.splice(userIndex, 1);
                localStorage.setItem('users', JSON.stringify(users));
                loadUserManagementData();
                alert('User deleted successfully');
            }
        }

        // Load settings
        function loadSettings() {
            document.getElementById('systemName').value = settings.systemName || 'Car Rental System';
            document.getElementById('systemCurrency').value = settings.currency || 'AED';
            document.getElementById('systemDateFormat').value = settings.dateFormat || 'dd/mm/yyyy';
            document.getElementById('backupInterval').value = settings.backupInterval || 'weekly';
            
            // Update system name in header and sidebar
            document.getElementById('headerSystemName').textContent = settings.systemName || 'Car Rental System';
            document.getElementById('sidebarSystemName').textContent = settings.systemName || 'Car Rental System';
            
            // Update logo if exists
            if (settings.logo) {
                document.getElementById('headerLogo').src = settings.logo;
                document.getElementById('headerLogo').style.display = 'inline';
                document.getElementById('sidebarLogo').src = settings.logo;
                document.getElementById('sidebarLogo').style.display = 'block';
            }
        }

        // Generate a unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Generate invoice code
        function generateInvoiceCode() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `INV-${year}${month}${day}-${random}`;
        }

        // Format date based on system settings
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            const format = settings.dateFormat || 'dd/mm/yyyy';
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            
            switch (format) {
                case 'dd/mm/yyyy':
                    return `${day}/${month}/${year}`;
                case 'mm/dd/yyyy':
                    return `${month}/${day}/${year}`;
                case 'yyyy-mm-dd':
                    return `${year}-${month}-${day}`;
                default:
                    return `${day}/${month}/${year}`;
            }
        }

        // Report generation functions
        function generateRentalReport(startDate, endDate) {
            let filteredRentals = rentals;
            
            if (startDate && endDate) {
                filteredRentals = rentals.filter(rental => {
                    const rentalDate = new Date(rental.startDate);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    return rentalDate >= start && rentalDate <= end;
                });
            }
            
            let reportHTML = `<h4>Rental Report</h4>`;
            reportHTML += `<p>Period: ${startDate || 'All time'} to ${endDate || 'All time'}</p>`;
            reportHTML += `<table class="table table-striped"><thead><tr><th>Invoice Code</th><th>Customer</th><th>Vehicle</th><th>Start Date</th><th>End Date</th><th>Amount</th><th>Status</th></tr></thead><tbody>`;
            
            let totalAmount = 0;
            filteredRentals.forEach(rental => {
                reportHTML += `<tr><td>${rental.invoiceCode}</td><td>${rental.customerName}</td><td>${rental.vehicleName}</td><td>${formatDate(rental.startDate)}</td><td>${formatDate(rental.endDate)}</td><td>${rental.totalAmount} AED</td><td>${rental.status}</td></tr>`;
                totalAmount += rental.totalAmount;
            });
            
            reportHTML += `</tbody></table>`;
            reportHTML += `<p><strong>Total Rental Amount: ${totalAmount.toFixed(2)} AED</strong></p>`;
            reportHTML += `<p><strong>Total Rentals: ${filteredRentals.length}</strong></p>`;
            
            return reportHTML;
        }

        function generateFinancialReport(startDate, endDate) {
            let filteredPayments = payments;
            let filteredRentals = rentals;
            
            if (startDate && endDate) {
                filteredPayments = payments.filter(payment => {
                    const paymentDate = new Date(payment.paymentDate);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    return paymentDate >= start && paymentDate <= end;
                });
                
                filteredRentals = rentals.filter(rental => {
                    const rentalDate = new Date(rental.startDate);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    return rentalDate >= start && rentalDate <= end;
                });
            }
            
            const totalRevenue = filteredPayments.reduce((sum, payment) => sum + payment.amount, 0);
            const totalRentalAmount = filteredRentals.reduce((sum, rental) => sum + rental.totalAmount, 0);
            const outstandingDebt = totalRentalAmount - totalRevenue;
            
            let reportHTML = `<h4>Financial Report</h4>`;
            reportHTML += `<p>Period: ${startDate || 'All time'} to ${endDate || 'All time'}</p>`;
            reportHTML += `<table class="table table-striped"><tbody>`;
            reportHTML += `<tr><td><strong>Total Revenue</strong></td><td>${totalRevenue.toFixed(2)} AED</td></tr>`;
            reportHTML += `<tr><td><strong>Total Rental Amount</strong></td><td>${totalRentalAmount.toFixed(2)} AED</td></tr>`;
            reportHTML += `<tr><td><strong>Outstanding Debt</strong></td><td>${outstandingDebt.toFixed(2)} AED</td></tr>`;
            reportHTML += `</tbody></table>`;
            
            return reportHTML;
        }

        function generateVehicleReport() {
            let reportHTML = `<h4>Vehicle Report</h4>`;
            reportHTML += `<table class="table table-striped"><thead><tr><th>Vehicle</th><th>Model</th><th>Color</th><th>Plate</th><th>Status</th><th>Rental Price</th></tr></thead><tbody>`;
            
            vehicles.forEach(vehicle => {
                reportHTML += `<tr><td>${vehicle.name}</td><td>${vehicle.model}</td><td>${vehicle.color}</td><td>${vehicle.plate}</td><td>${vehicle.status}</td><td>${vehicle.rentalPrice} AED</td></tr>`;
            });
            
            reportHTML += `</tbody></table>`;
            reportHTML += `<p><strong>Total Vehicles: ${vehicles.length}</strong></p>`;
            reportHTML += `<p><strong>Available: ${vehicles.filter(v => v.status === 'Available').length}</strong></p>`;
            reportHTML += `<p><strong>Rented: ${vehicles.filter(v => v.status === 'Rented').length}</strong></p>`;
            reportHTML += `<p><strong>In Maintenance: ${vehicles.filter(v => v.status === 'Maintenance').length}</strong></p>`;
            
            return reportHTML;
        }

        function generateCustomerReport() {
            let reportHTML = `<h4>Customer Report</h4>`;
            reportHTML += `<table class="table table-striped"><thead><tr><th>Customer</th><th>Age</th><th>ID</th><th>Nationality</th><th>Contact</th><th>Total Debt</th></tr></thead><tbody>`;
            
            customers.forEach(customer => {
                const rentalDebt = calculateRentalDebt(customer.id);
                const finesDebt = calculateFinesDebt(customer.id);
                const totalDebt = rentalDebt + finesDebt;
                
                reportHTML += `<tr><td>${customer.fullName}</td><td>${customer.age}</td><td>${customer.idNumber}</td><td>${customer.nationality}</td><td>${customer.contact}</td><td>${totalDebt.toFixed(2)} AED</td></tr>`;
            });
            
            reportHTML += `</tbody></table>`;
            reportHTML += `<p><strong>Total Customers: ${customers.length}</strong></p>`;
            
            return reportHTML;
        }

        // Export functions
        function exportRentalReportToCSV(startDate, endDate) {
            let filteredRentals = rentals;
            
            if (startDate && endDate) {
                filteredRentals = rentals.filter(rental => {
                    const rentalDate = new Date(rental.startDate);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    return rentalDate >= start && rentalDate <= end;
                });
            }
            
            let csv = 'Invoice Code,Customer,Vehicle,Start Date,End Date,Amount,Status\n';
            filteredRentals.forEach(rental => {
                csv += `"${rental.invoiceCode}","${rental.customerName}","${rental.vehicleName}","${formatDate(rental.startDate)}","${formatDate(rental.endDate)}",${rental.totalAmount},"${rental.status}"\n`;
            });
            
            return csv;
        }

        function exportFinancialReportToCSV(startDate, endDate) {
            let filteredPayments = payments;
            let filteredRentals = rentals;
            
            if (startDate && endDate) {
                filteredPayments = payments.filter(payment => {
                    const paymentDate = new Date(payment.paymentDate);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    return paymentDate >= start && paymentDate <= end;
                });
                
                filteredRentals = rentals.filter(rental => {
                    const rentalDate = new Date(rental.startDate);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    return rentalDate >= start && rentalDate <= end;
                });
            }
            
            const totalRevenue = filteredPayments.reduce((sum, payment) => sum + payment.amount, 0);
            const totalRentalAmount = filteredRentals.reduce((sum, rental) => sum + rental.totalAmount, 0);
            const outstandingDebt = totalRentalAmount - totalRevenue;
            
            let csv = 'Metric,Value\n';
            csv += `Total Revenue,${totalRevenue.toFixed(2)}\n`;
            csv += `Total Rental Amount,${totalRentalAmount.toFixed(2)}\n`;
            csv += `Outstanding Debt,${outstandingDebt.toFixed(2)}\n`;
            
            return csv;
        }

        function exportVehicleReportToCSV() {
            let csv = 'Vehicle,Model,Color,Plate,Status,Rental Price\n';
            vehicles.forEach(vehicle => {
                csv += `"${vehicle.name}","${vehicle.model}","${vehicle.color}","${vehicle.plate}","${vehicle.status}",${vehicle.rentalPrice}\n`;
            });
            
            return csv;
        }

        function exportCustomerReportToCSV() {
            let csv = 'Customer,Age,ID,Nationality,Contact,Total Debt\n';
            customers.forEach(customer => {
                const rentalDebt = calculateRentalDebt(customer.id);
                const finesDebt = calculateFinesDebt(customer.id);
                const totalDebt = rentalDebt + finesDebt;
                
                csv += `"${customer.fullName}",${customer.age},"${customer.idNumber}","${customer.nationality}","${customer.contact}",${totalDebt.toFixed(2)}\n`;
            });
            
            return csv;
        }

        // Close suggestion lists when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.matches('.suggestion-item') && !e.target.matches('.suggestion-list')) {
                document.querySelectorAll('.suggestion-list').forEach(list => {
                    list.style.display = 'none';
                });
            }
        });
    </script>
</body>
</html>